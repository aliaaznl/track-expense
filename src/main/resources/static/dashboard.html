<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrackExpense</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Dashboard JavaScript Modules - Load in order -->
    <script src="js/dashboard-common.js"></script>
    <script src="js/dashboard-init.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'DM Sans', sans-serif; }
        html { font-size: 14px; } /* Base font size - reduced */
        body { background-color: #000; color: #fff; min-height: 100vh; display: flex; overflow: hidden; font-size: 14px; }

        /* Sidebar Styles */
        .sidebar { width: 80px; background: #000; height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px 0; position: fixed; left: 0; top: 0; z-index: 100; }
        .sidebar-logo { width: 40px; height: 40px; margin-bottom: 30px; background: transparent; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .sidebar-logo img { width: 100%; height: 100%; object-fit: contain; }
        .sidebar-menu { display: flex; flex-direction: column; gap: 20px; width: 100%; align-items: center; position: relative; flex: 1; }
        .sidebar-bottom { display: flex; flex-direction: column; gap: 20px; width: 100%; align-items: center; margin-top: auto; margin-bottom: 20px; }
        .sidebar-logout { margin: 0; }
        .sidebar-item { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; position: relative; color: #fff; }
        .sidebar-item:hover { color: #fff; }
        .sidebar-item.active { color: #fff; }
        .sidebar-item i { font-size: 20px; color: #fff; }
        .sidebar-item .tooltip { position: absolute; left: 70px; background: #18181b; color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 12px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 1000; border: 1px solid #27272a; }
        .sidebar-item:hover .tooltip { opacity: 1; }
        .sidebar-indicator { position: absolute; left: 0; width: 4px; background: linear-gradient(180deg, #b5ff7d 0%, #48c6ef 100%); border-radius: 0 4px 4px 0; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); height: 48px; z-index: 10; }

        /* Main Content Area */
        .main-content { flex: 1; margin-left: 80px; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Top Header */
        .top-header { background: #000; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #27272a; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .greeting { display: flex; flex-direction: column; }
        .greeting h2 { font-size: 18px; font-weight: 600; color: #fff; margin: 0; }
        .greeting p { font-size: 12px; color: #a1a1aa; margin: 0; }
        .header-right { display: flex; align-items: center; gap: 20px; }
        .header-icon { width: 36px; height: 36px; border-radius: 50%; background: #27272a; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; color: #fff; position: relative; }
        .header-icon:hover { background: #3f3f46; }
        .header-icon i { color: #fff; font-size: 16px; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #b5ff7d 0%, #48c6ef 100%); display: flex; align-items: center; justify-content: center; color: #000; font-weight: 600; cursor: pointer; font-size: 14px; }

        /* Content Area */
        .content-area { 
            flex: 1; 
            overflow-y: auto; 
            padding: 24px; 
            background: #18181b; 
            width: 100%; 
            box-sizing: border-box;
            min-width: 0;
        }
        .content-area::-webkit-scrollbar { width: 8px; }
        .content-area::-webkit-scrollbar-track { background: transparent; }
        .content-area::-webkit-scrollbar-thumb { background: #27272a; border-radius: 4px; }
        .content-area::-webkit-scrollbar-thumb:hover { background: #3f3f46; }
        .content-area { scrollbar-width: thin; scrollbar-color: #27272a transparent; }
        .view { 
            display: none !important; 
            width: 100%; 
            max-width: 100%; 
            box-sizing: border-box;
            min-width: 0;
        }
        .view.active { 
            display: block !important; 
            width: 100%; 
            max-width: 100%; 
            box-sizing: border-box;
            min-width: 0;
        }
        /* Force hide all non-active views completely */
        .view:not(.active) {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            min-height: 0 !important;
            overflow: hidden !important;
            position: absolute !important;
            left: -9999px !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        /* Ensure exports view matches settings view styling - no special overrides needed */

        /* Dashboard Cards */
        .dashboard-cards { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; 
            margin-bottom: 24px; 
            width: 100%; 
            box-sizing: border-box;
            min-width: 0;
        }
        /* Ensure overview doesn't take space when hidden */
        #overview:not(.active) .dashboard-cards,
        #overview:not(.active) * {
            display: none !important;
            height: 0 !important;
            min-height: 0 !important;
        }
        .dashboard-card { background: #0f0f0f; padding: 20px; border-radius: 16px; border: 1px solid #27272a; display: flex; align-items: center; gap: 14px; }
        .dashboard-card-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
        .dashboard-card-icon.income { background: #1a2e1a; color: #b5ff7d; }
        .dashboard-card-icon.expense { background: #2e1a1a; color: #ff5757; }
        .dashboard-card-content { flex: 1; }
        .dashboard-card-title { font-size: 11px; color: #a1a1aa; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .dashboard-card-amount { font-size: 24px; font-weight: 700; color: #fff; }
        
        /* Chart Container */
        .chart-container { 
            background: #0f0f0f; 
            padding: 20px; 
            border-radius: 16px; 
            border: 1px solid #27272a; 
            margin-bottom: 24px; 
            min-width: 0; 
            max-width: 100%; 
            box-sizing: border-box;
            overflow: hidden;
        }
        .chart-title { font-size: 16px; font-weight: 600; color: #fff; margin-bottom: 16px; }
        
        .expense-filter-btn {
            padding: 6px 12px;
            background: #27272a;
            border: 1px solid #3f3f46;
            border-radius: 6px;
            color: #a1a1aa;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .expense-filter-btn:hover {
            background: #3f3f46;
            color: #fff;
        }
        
        .expense-filter-btn.active {
            background: #3f3f46;
            border-color: #52525b;
            color: #fff;
        }
        
        /* Upcoming Bills Cards */
        .bill-card { background: #18181b; border: 1px solid #27272a; border-radius: 10px; padding: 12px; display: flex; align-items: center; gap: 12px; transition: all 0.2s; cursor: pointer; }
        .bill-card:hover { border-color: #3f3f46; transform: translateY(-2px); }
        .bill-card.featured { grid-column: 1 / -1; padding: 16px; }
        .bill-card-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .bill-card-icon.rent { background: #27272a; color: #fff; }
        .bill-card-icon.streaming { background: #dc2626; color: #fff; }
        .bill-card-icon.music { background: #27272a; color: #fff; }
        .bill-card-icon.phone { background: #27272a; color: #fff; }
        .bill-card-icon.utilities { background: #27272a; color: #fff; }
        .bill-card-content { flex: 1; min-width: 0; }
        .bill-card-name { font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 3px; }
        .bill-card-due { font-size: 12px; color: #a1a1aa; }
        .bill-card-amount { text-align: right; }
        .bill-card-amount-value { font-size: 16px; font-weight: 600; color: #ff5757; }
        .bill-card-amount-label { font-size: 10px; color: #ff5757; margin-top: 2px; }
        .bills-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .chart-wrapper { 
            position: relative; 
            height: 280px; 
            max-height: 280px; 
            display: flex; 
            align-items: center; 
            justify-content: flex-start; 
            overflow: hidden; 
            padding: 0 10px; 
            width: 100%; 
            box-sizing: border-box;
            min-width: 0;
        }
        #chart-legend { display: flex; flex-direction: column; justify-content: center; margin-left: 24px; min-width: 150px; max-width: 200px; flex-shrink: 0; overflow: hidden; }

        .header-row { display: flex; justify-content: space-between; width: 100%; align-items: center; margin-bottom: 20px; }
        
        /* Pagination Styles */
        #pagination-controls button:hover:not(:disabled) { background: #27272a !important; border-color: #3f3f46 !important; }
        #pagination-controls button:disabled { opacity: 0.5; cursor: not-allowed !important; }
        .add-btn { padding: 10px 20px; background: linear-gradient(90deg, #b5ff7d 0%, #48c6ef 100%); color: #000; border: none; border-radius: 12px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 15px rgba(181, 255, 125, 0.3); min-width: 130px; box-sizing: border-box; }
        .add-btn:hover { transform: scale(1.05); }
        .add-btn:active { transform: scale(0.95); }
        .export-btn { padding: 10px 20px; background: #18181b; color: #fff; border: 1px solid #27272a; border-radius: 8px; font-weight: 500; font-size: 13px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; height: 37px; box-sizing: border-box; min-width: 130px; justify-content: center; }
        .export-btn:hover { border-color: #3f3f46; background: #27272a; }
        .export-btn i { font-size: 16px; }
        
        table { width: 100%; border-collapse: collapse; background: #0f0f0f; border-radius: 16px; overflow: hidden; border: 1px solid #27272a; }
        th, td { padding: 14px; text-align: left; border-bottom: 1px solid #27272a; font-size: 13px; }
        th { color: #a1a1aa; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .sortable-header { transition: color 0.2s ease; }
        .sortable-header:hover { color: #fff; }
        .sortable-header:hover #date-sort-icon { color: #fff; }
        td { color: #fff; font-size: 13px; }
        tbody tr:hover { background: #1a1a1a; }
        
        /* Action Buttons */
        .action-buttons { display: flex; gap: 8px; align-items: center; }
        .action-btn { width: 32px; height: 32px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 14px; }
        .edit-btn { background: #3f3f46; color: #fff; }
        .edit-btn:hover { background: #52525b; transform: scale(1.1); }
        .delete-btn { background: #3f3f46; color: #fff; }
        .delete-btn:hover { background: #52525b; transform: scale(1.1); }
        .checkbox-cell { text-align: center; }
        /* Style all checkboxes with grey theme and centered checkmark */
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            border: 2px solid #52525b;
            border-radius: 4px;
            background-color: transparent;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            position: relative;
            margin: 0;
            padding: 0;
            flex-shrink: 0;
        }
        input[type="checkbox"]:checked {
            background-color: #52525b;
            border-color: #52525b;
        }
        input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 4px;
            height: 8px;
            border: solid #18181b;
            border-width: 0 2px 2px 0;
            transform: translate(-50%, -65%) rotate(45deg);
        }
        
        /* Search and Filter Styles */
        .search-filter-container { position: relative; display: inline-block; }
        .search-filter-container input:focus { border-color: #52525b !important; }
        #custom-date-range { display: none; align-items: center; gap: 8px; flex-wrap: nowrap; }
        #custom-date-range input[type="date"] { 
            min-width: 150px; 
            padding: 8px 12px; 
            background: #0f0f0f; 
            border: 1px solid #27272a; 
            border-radius: 8px; 
            color: #fff; 
            font-size: 13px; 
            outline: none;
            box-sizing: border-box;
            line-height: 1.5;
            height: 37px;
        }
        #custom-date-range input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
            opacity: 1;
        }
        /* Firefox-specific date picker styling - valid CSS */
        #custom-date-range input[type="date"]::-moz-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
        #export-custom-date-range {
            display: none;
            align-items: center;
            gap: 8px;
        }
        #export-custom-date-range input[type="date"] {
            min-width: 150px;
            padding: 8px 12px;
            background: #0f0f0f;
            border: 1px solid #27272a;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            outline: none;
            box-sizing: border-box;
            line-height: 1.5;
            height: 37px;
        }
        #export-custom-date-range input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
            opacity: 1;
        }
        /* Firefox-specific date picker styling - valid CSS */
        #export-custom-date-range input[type="date"]::-moz-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
        select option { background: #18181b; color: #fff; }
        select optgroup { color: #a1a1aa; font-weight: 600; }
        .attachment-badge { display: inline-flex; align-items: center; gap: 4px; background: #3f3f46; padding: 4px 8px; border-radius: 6px; font-size: 11px; color: #fff; cursor: pointer; transition: all 0.2s; }
        .attachment-badge:hover { background: #52525b; transform: scale(1.05); }
        
        /* Category Management Styles */
        .category-card { background: #18181b; border: 1px solid #27272a; border-radius: 10px; padding: 12px; display: flex; align-items: center; gap: 10px; transition: all 0.2s; }
        .category-card:hover { border-color: #3f3f46; }
        .category-card-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
        .category-card-info { flex: 1; min-width: 0; }
        .category-card-name { font-size: 13px; font-weight: 600; color: #fff; margin-bottom: 3px; }
        .category-card-actions { display: flex; gap: 6px; }
        .category-card-btn { width: 28px; height: 28px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 12px; background: #27272a; color: #fff; }
        .category-card-btn:hover { background: #3f3f46; transform: scale(1.1); }
        .icon-option { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; background: #27272a; color: #a1a1aa; border: 2px solid transparent; font-size: 16px; }
        .icon-option:hover { background: #3f3f46; border-color: #52525b; }
        .icon-option.selected { background: #3f3f46; border-color: #b5ff7d; color: #b5ff7d; }
        
        /* Lightbox for viewing attachments */
        .lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1002; align-items: center; justify-content: center; padding: 16px; flex-direction: column; }
        .lightbox.active { display: flex; }
        .lightbox img { max-width: 90%; max-height: 80%; border-radius: 10px; }
        .lightbox iframe { width: 90%; height: 80%; border-radius: 10px; border: none; }
        .lightbox-close { position: absolute; top: 16px; right: 16px; background: #27272a; border: none; color: #fff; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 18px; z-index: 101; }
        .lightbox-nav { position: absolute; top: 50%; transform: translateY(-50%); background: #27272a; border: none; color: #fff; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; font-size: 18px; }
        .lightbox-nav.prev { left: 16px; }
        .lightbox-nav.next { right: 16px; }
        .lightbox-error { color: #ff5757; text-align: center; padding: 32px; }
        .lightbox-error i { font-size: 40px; margin-bottom: 12px; display: block; }
        .lightbox-download { display: inline-flex; align-items: center; gap: 6px; background: linear-gradient(90deg, #b5ff7d 0%, #48c6ef 100%); color: #000; padding: 10px 20px; border-radius: 10px; text-decoration: none; font-weight: 600; font-size: 13px; margin-top: 12px; }
        .lightbox-counter { position: absolute; bottom: 16px; color: #a1a1aa; font-size: 12px; }

        .logout-btn { margin-top:50px; background:transparent; border:1px solid #27272a; color:#fff; padding:8px 20px; border-radius:100px; cursor:pointer; transition: all 0.2s; }
        .logout-btn:hover { background: #27272a; }

        /* Modal Styles */
        .modal-backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 1000; animation: fadeInBackdrop 0.2s ease; }
        .modal { display: none; position: fixed; inset: 0; z-index: 1001; align-items: center; justify-content: center; padding: 12px; }
        .modal-content { background: #000; border-radius: 16px; width: 100%; max-width: 600px; max-height: 90vh; overflow: hidden; animation: slideUpModal 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); border: 1px solid #27272a; }
        
        /* Custom Dialog Modal Styles */
        .dialog-modal { display: none; position: fixed; inset: 0; z-index: 1002; align-items: center; justify-content: center; padding: 16px; }
        .dialog-content { background: #0f0f0f; border-radius: 16px; width: 100%; max-width: 400px; padding: 24px; border: 1px solid #27272a; animation: slideUpModal 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .dialog-title { font-size: 18px; font-weight: 600; color: #fff; margin-bottom: 16px; }
        .dialog-message { font-size: 14px; color: #a1a1aa; margin-bottom: 24px; line-height: 1.5; }
        .dialog-buttons { display: flex; gap: 12px; justify-content: flex-end; }
        .dialog-btn { padding: 10px 20px; border-radius: 8px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .dialog-btn-primary { background: #3f3f46; color: #fff; }
        .dialog-btn-primary:hover { background: #52525b; }
        .dialog-btn-secondary { background: #27272a; color: #fff; }
        .dialog-btn-secondary:hover { background: #3f3f46; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 20px; background: #000; z-index: 10; border-bottom: 1px solid #18181b; }
        .modal-header h2 { font-size: 16px; font-weight: 600; color: #fff; margin: 0; }
        .close-btn { 
            padding: 4px; 
            background: #18181b; 
            border: none; 
            border-radius: 6px; 
            color: #fff; 
            cursor: pointer; 
            transition: opacity 0.2s; 
            font-size: 16px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            width: 28px; 
            height: 28px; 
        }
        .close-btn:hover { opacity: 0.7; }
        .close-btn svg { 
            width: 16px; 
            height: 16px; 
            display: block; 
        }
        .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 14px; overflow-y: auto; max-height: calc(90vh - 90px); }
        
        /* Custom Scrollbar Styling - Seamless Dark Theme */
        .modal-body::-webkit-scrollbar { width: 8px; }
        .modal-body::-webkit-scrollbar-track { background: transparent; }
        .modal-body::-webkit-scrollbar-thumb { background: #27272a; border-radius: 4px; }
        .modal-body::-webkit-scrollbar-thumb:hover { background: #3f3f46; }
        
        /* Firefox scrollbar */
        .modal-body { scrollbar-width: thin; scrollbar-color: #27272a transparent; }

        /* Amount Input */
        .amount-input { width: 100%; background: #18181b; border: 2px solid transparent; padding: 12px; color: #b5ff7d; border-radius: 10px; font-size: 16px; font-weight: 600; text-align: left; transition: all 0.2s ease; font-variant-numeric: tabular-nums; }
        .amount-input:focus { border-color: #b5ff7d; outline: none; }
        .amount-input::placeholder { color: #52525b; }

        /* Expense/Income Tabs */
        .tab-wrapper { display: flex; gap: 6px; margin-bottom: 18px; }
        .tab-btn { flex: 1; padding: 10px; background: #18181b; border: none; border-radius: 10px; font-size: 13px; font-weight: 600; color: #a1a1aa; cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative; }
        .tab-btn.active { background: #27272a; color: #fff; transform: scale(1.02); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -3px; left: 20%; right: 20%; height: 2px; background: linear-gradient(90deg, #b5ff7d 0%, #48c6ef 100%); border-radius: 2px; }

        /* Category Dropdown - Custom */
        .category-dropdown-wrapper { position: relative; }
        .category-select { width: 100%; background: #18181b; border: 2px solid transparent; padding: 12px 14px; color: #fff; border-radius: 10px; font-size: 13px; cursor: pointer; transition: all 0.2s ease; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a1a1aa' d='M6 9L1 4h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; padding-right: 50px; }
        .category-select:focus { border-color: #b5ff7d; outline: none; }
        .category-select option { padding: 10px 14px; background: #18181b; color: #fff; }
        .category-select option:checked { background: #27272a; }

        /* Input Fields */
        .input-group { margin-bottom: 0; }
        .input-group label { display: block; font-size: 12px; font-weight: 500; color: #a1a1aa; margin-bottom: 6px; }
        .input-group input, .input-group select { width: 100%; background: #18181b; border: 2px solid transparent; padding: 12px; color: #fff; border-radius: 10px; transition: all 0.2s ease; font-size: 13px; }
        .input-group select { padding-right: 50px; }
        .input-group input:focus, .input-group select:focus { border-color: #b5ff7d; outline: none; }
        .input-group input::placeholder { color: #52525b; }
        .input-group input[type="date"] { cursor: pointer; }
        .input-group input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        
        /* Two Column Layout for Amount and Category */
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .input-row.amount-only { grid-template-columns: 1fr; }
        #category-group { display: block; }
        #category-group.hidden { display: none !important; }
        
        /* Recurring Section */
        .recurring-section { margin-bottom: 0; }
        .recurring-toggle-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .recurring-toggle-label { font-size: 13px; font-weight: 500; color: #a1a1aa; }
        .toggle-button { position: relative; width: 44px; height: 24px; background: #27272a; border: 2px solid #3f3f46; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; }
        .toggle-button.active { background: linear-gradient(90deg, #b5ff7d 0%, #48c6ef 100%); border-color: transparent; }
        .toggle-button::after { content: ''; position: absolute; width: 18px; height: 18px; background: #fff; border-radius: 50%; top: 50%; left: 3px; transform: translateY(-50%); transition: all 0.3s ease; }
        .toggle-button.active::after { left: 23px; }
        .recurring-options { display: none; margin-top: 10px; }
        .recurring-options.active { display: block; }
        .recurring-options select { width: 100%; }

        /* Save Button */
        .save-btn { width: 100%; padding: 14px; background: linear-gradient(90deg, #b5ff7d 0%, #48c6ef 100%); color: #000; border: none; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s ease; }
        .save-btn:hover { transform: scale(1.02); }
        .save-btn:active { transform: scale(0.98); }
        .save-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        /* Attachment Section - Minimal */
        .attachment-section { margin-bottom: 0; }
        .attachment-label { display: block; font-size: 12px; font-weight: 500; color: #a1a1aa; margin-bottom: 6px; }
        .attachment-minimal { display: flex; align-items: center; gap: 10px; background: #0f0f0f; border: 2px dashed #27272a; border-radius: 10px; padding: 10px 14px; cursor: pointer; transition: all 0.2s ease; }
        .attachment-minimal:hover, .attachment-minimal.dragover { border-color: #3f3f46; background: #1a1a1a; }
        .attachment-minimal i { font-size: 16px; color: #fff; }
        .attachment-minimal span { color: #a1a1aa; font-size: 12px; flex: 1; }
        .attachment-input { display: none; }
        
        /* Attachment Preview */
        .attachment-preview { display: none; margin-top: 10px; }
        .attachment-preview.has-files { display: flex; flex-wrap: wrap; gap: 6px; }
        .attachment-item { position: relative; background: #0f0f0f; border-radius: 8px; padding: 6px 10px; display: flex; align-items: center; gap: 6px; animation: fadeIn 0.2s ease; }
        .attachment-item i { color: #b5ff7d; font-size: 14px; }
        .attachment-item .file-info { flex: 1; min-width: 0; }
        .attachment-item .file-name { color: #fff; font-size: 11px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; display: block; }
        .attachment-item .file-size { color: #52525b; font-size: 9px; }
        .attachment-item .remove-btn { background: #3f3f46; color: #fff; border: none; width: 16px; height: 16px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 9px; transition: transform 0.15s; }
        .attachment-item .remove-btn:hover { background: #52525b; }
        .attachment-item .remove-btn:hover { transform: scale(1.1); }
        
        /* Image Preview Thumbnail */
        .attachment-item .thumb { width: 36px; height: 36px; border-radius: 6px; object-fit: cover; }

        /* Animations */
        @keyframes fadeInBackdrop { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUpModal { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes bounceSelect { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        /* Responsive adjustments for smaller windows */
        @media (max-width: 1200px) {
            .dashboard-cards {
                grid-template-columns: repeat(auto-fit, minmax(min(350px, 100%), 1fr)) !important;
            }
        }
        
        @media (max-width: 900px) {
            .dashboard-cards {
                grid-template-columns: 1fr !important;
            }
            .chart-container {
                max-width: 100% !important;
                width: 100% !important;
            }
        }
        
        /* Budget Styles */
        .budget-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; width: 100%; }
        .budget-card { background: #0f0f0f; border: 1px solid #27272a; border-radius: 12px; padding: 16px; transition: all 0.2s ease; min-height: 180px; display: flex; flex-direction: column; cursor: pointer; }
        .budget-card:hover { transform: translateY(-2px); border-color: #3f3f46; }
        .budget-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-shrink: 0; }
        .budget-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .budget-info { flex: 1; min-width: 0; }
        .budget-category { font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 3px; }
        .budget-item-count { font-size: 11px; color: #a1a1aa; }
        .budget-amount { font-size: 18px; font-weight: 700; color: #fff; text-align: right; }
        .budget-stats { display: flex; justify-content: space-between; margin-top: auto; margin-bottom: 6px; font-size: 11px; flex-shrink: 0; }
        .budget-spent { color: #ff5757; }
        .budget-remaining { color: #b5ff7d; }
        .budget-progress-bar { width: 100%; height: 6px; background: #18181b; border-radius: 3px; overflow: hidden; margin-top: 6px; flex-shrink: 0; }
        .budget-progress-fill { height: 100%; background: linear-gradient(90deg, #b5ff7d 0%, #48c6ef 100%); border-radius: 3px; transition: width 0.3s ease; }
        .budget-card.create-new { border: 2px dashed #27272a; background: #0f0f0f; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; }
        .budget-card.create-new:hover { border-color: #3f3f46; background: #1a1a1a; }
        .create-budget-icon { font-size: 40px; color: #a1a1aa; margin-bottom: 10px; }
        .create-budget-text { color: #a1a1aa; font-size: 13px; font-weight: 500; }
        
        /* Budget Modal */
        .budget-modal-content { max-width: 480px; }
        .budget-modal-body { padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .budget-modal-body .input-group { margin-bottom: 0; }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-logo">
            <img src="/logo.png" alt="Logo" onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=\'color:#fff; font-weight:700;\'>ET</span>'">
        </div>
        <div class="sidebar-indicator" id="sidebar-indicator"></div>
        <div class="sidebar-menu">
            <div class="sidebar-item active" onclick="switchView('overview', this)" data-view="overview">
                <i class="fa-solid fa-th-large"></i>
                <span class="tooltip">Dashboard</span>
            </div>
            <div class="sidebar-item" onclick="switchView('transactions', this)" data-view="transactions">
                <i class="fa-solid fa-receipt"></i>
                <span class="tooltip">Transactions</span>
            </div>
            <div class="sidebar-item" onclick="switchView('budget', this)" data-view="budget">
                <i class="fa-solid fa-wallet"></i>
                <span class="tooltip">Budget</span>
            </div>
            <div class="sidebar-item" onclick="switchView('exports', this)" data-view="exports">
                <i class="fa-solid fa-file-export"></i>
                <span class="tooltip">Exports</span>
            </div>
        </div>
        <div class="sidebar-bottom">
            <div class="sidebar-item" onclick="switchView('settings', this)" data-view="settings">
                <i class="fa-solid fa-gear"></i>
                <span class="tooltip">Settings</span>
            </div>
            <div class="sidebar-item sidebar-logout" onclick="confirmLogout()">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span class="tooltip">Logout</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Header -->
        <div class="top-header">
            <div class="header-left">
                <div class="greeting">
                    <h2 id="greeting-text">Hi, User</h2>
                    <p id="user-role">Welcome back</p>
                </div>
            </div>
            <div class="header-right">
                <div class="user-avatar" onclick="showUserMenu()" id="user-avatar">
                    <span id="user-initial">U</span>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Exports View - Moved to top -->
            <div id="exports" class="view" style="display: none;">
                <h2 style="font-size: 20px; font-weight: 600; color: #fff; margin-bottom: 20px;">Export History</h2>
                
                <div style="background: #0f0f0f; padding: 20px; border-radius: 12px; border: 1px solid #27272a;">
                    <!-- Selection Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #27272a;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <input type="checkbox" id="select-all-exports-checkbox" onchange="toggleSelectAllExports()">
                            <span id="selected-exports-count" style="color: #a1a1aa; font-size: 13px;">0 selected</span>
                        </div>
                        <button id="bulk-delete-exports-btn" onclick="bulkDeleteExports()" style="display: none; background: #ff5757; color: #fff; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s;" onmouseover="this.style.background='#ff4040'" onmouseout="this.style.background='#ff5757'">
                            <i class="fa-solid fa-trash" style="margin-right: 6px;"></i>Delete Selected
                        </button>
                    </div>
                    
                    <div id="exports-list" style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- Export history will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Overview/Dashboard View -->
            <div id="overview" class="view active">
                <div class="dashboard-cards">
                    <div class="dashboard-card">
                        <div class="dashboard-card-icon income">
                            <i class="fa-solid fa-arrow-trend-up"></i>
                        </div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-title">Total Income</div>
                            <div class="dashboard-card-amount" id="dash-income">RM 0.00</div>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <div class="dashboard-card-icon expense">
                            <i class="fa-solid fa-arrow-trend-down"></i>
                        </div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-title">Total Expenses</div>
                            <div class="dashboard-card-amount" id="dash-expense">RM 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Side by Side -->
                <div class="dashboard-cards" style="grid-template-columns: repeat(auto-fit, minmax(min(400px, calc(100% - 48px)), 1fr)); gap: 20px; width: 100%; max-width: 100%; box-sizing: border-box; padding: 0; margin: 0 0 24px 0;">
                    <!-- Expense by Category Chart -->
                    <div class="chart-container" style="margin-bottom: 0; width: 100%; max-width: 100%; min-width: 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div class="chart-title">Expense by Category</div>
                            <select id="chart-period-select" onchange="updateChartPeriod()" style="padding: 7px 30px 7px 10px; background: #18181b; border: 2px solid #27272a; border-radius: 8px; color: #fff; font-size: 13px; cursor: pointer; outline: none; transition: all 0.2s; appearance: none; background-image: url('data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'12\' height=\'12\' viewBox=\'0 0 12 12\'%3E%3Cpath fill=\'%23a1a1aa\' d=\'M6 9L1 4h10z\'/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 14px center;">
                            <option value="all">All Time</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="categoryChart"></canvas>
                        <div id="chart-legend"></div>
                    </div>
                </div>

                <!-- Upcoming Expense Cards -->
                    <div class="chart-container" style="margin-bottom: 0; width: 100%; max-width: 100%; min-width: 0;">
                    <div class="chart-title">Upcoming Expense</div>
                    <div style="display: flex; gap: 8px; margin-top: 12px; margin-bottom: 16px; margin-left: 0; padding: 0;">
                        <button id="filter-today" class="expense-filter-btn active" onclick="setExpenseFilter('today')">Today</button>
                        <button id="filter-week" class="expense-filter-btn" onclick="setExpenseFilter('week')">This Week</button>
                        <button id="filter-month" class="expense-filter-btn" onclick="setExpenseFilter('month')">This Month</button>
                    </div>
                        <div id="upcoming-bills-container" style="display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 16px;">
                        <!-- Recurring expenses will be dynamically inserted here -->
                    </div>
                    </div>
                </div>
                
                <!-- Monthly Income & Expenses Bar Chart -->
                <div class="chart-container" style="margin-top: 24px; width: 100%; max-width: 100%; min-width: 0;">
                    <div class="chart-title">Monthly Income & Expenses</div>
                    <div class="chart-wrapper" style="height: 300px;">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Transactions View -->
            <div id="transactions" class="view">
                <div class="header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: #fff;">Transactions</h2>
                    <div style="display: flex; gap: 12px; align-items: center;">
                    <button class="add-btn" onclick="openModal()">+ Add New</button>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; flex: 1; min-width: 0;">
                        <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll()">
                        <span id="selected-count" style="color: #a1a1aa; font-size: 13px;">0 selected</span>
                        
                        <!-- Delete Selected Button -->
                        <button id="bulk-delete-btn" onclick="bulkDeleteTransactions()" style="display: none; background: #ff5757; color: #fff; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; height: 37px; box-sizing: border-box; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.background='#ff4040'" onmouseout="this.style.background='#ff5757'">
                            <i class="fa-solid fa-trash"></i> Delete Selected
                        </button>
                        
                        <!-- Search Bar -->
                        <div class="search-filter-container">
                            <i class="fa-solid fa-search" style="color: #a1a1aa; position: absolute; left: 12px; top: 50%; transform: translateY(-50%);"></i>
                            <input type="text" id="search-transactions" placeholder="Search transactions" oninput="applyFilters()" style="width: 230px; padding: 8px 10px 8px 36px; background: #0f0f0f; border: 1px solid #27272a; border-radius: 8px; color: #fff; font-size: 13px; outline: none;">
                        </div>
                        
                        <!-- Type/Category Filter -->
                        <select id="filter-type-category" onchange="applyFilters()" style="padding: 8px 30px 8px 10px; background: #0f0f0f; border: 1px solid #27272a; border-radius: 8px; color: #fff; font-size: 13px; outline: none; cursor: pointer; min-width: 140px; appearance: none; background-image: url('data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'12\' height=\'12\' viewBox=\'0 0 12 12\'%3E%3Cpath fill=\'%23a1a1aa\' d=\'M6 9L1 4h10z\'/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 14px center; box-sizing: border-box; line-height: 1.5; height: 37px;">
                            <option value="">All Types & Categories</option>
                            <option value="EXPENSE">Expense</option>
                            <option value="INCOME">Income</option>
                            <optgroup label="By Category" id="category-filter-group"></optgroup>
                        </select>
                        
                        <!-- Date Range Filter -->
                        <select id="filter-date-range" onchange="handleDateRangeChange()" style="padding: 8px 30px 8px 10px; background: #0f0f0f; border: 1px solid #27272a; border-radius: 8px; color: #fff; font-size: 13px; outline: none; cursor: pointer; min-width: 140px; appearance: none; background-image: url('data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'12\' height=\'12\' viewBox=\'0 0 12 12\'%3E%3Cpath fill=\'%23a1a1aa\' d=\'M6 9L1 4h10z\'/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 14px center; box-sizing: border-box; line-height: 1.5; height: 37px;">
                            <option value="all">All Time</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="custom">Custom Date Range</option>
                        </select>
                        
                        <!-- Custom Date Range Inputs (hidden by default) -->
                        <div id="custom-date-range" style="display: none; align-items: center; gap: 8px; flex-wrap: nowrap;">
                            <input type="date" id="date-from" onchange="applyFilters()">
                            <span style="color: #a1a1aa;">to</span>
                            <input type="date" id="date-to" onchange="applyFilters()">
                        </div>
                    </div>
                    <!-- Export Button - Right Aligned (stays on right even when custom date range is shown) -->
                    <button class="export-btn" onclick="openExportModal()" title="Export Data" style="height: 37px; padding: 10px 20px; display: flex; align-items: center; gap: 6px; box-sizing: border-box; flex-shrink: 0; margin-left: auto;">
                        <i class="fa-solid fa-download"></i> Export
                    </button>
                </div>
                <table id="transactions-table">
                    <thead><tr><th style="width: 40px;"></th><th>Type</th><th>Category</th><th>Description</th><th>Amount</th><th class="sortable-header" onclick="toggleDateSort()" style="cursor: pointer; user-select: none;">Date <i id="date-sort-icon" class="fa-solid fa-arrow-up" style="margin-left: 6px; color: #a1a1aa; font-size: 11px;"></i></th><th>Attachment</th><th style="width: 100px;">Actions</th></tr></thead>
                    <tbody id="txn-tbody"></tbody>
                </table>
                
                <!-- Pagination Controls -->
                <div id="pagination-controls" style="display: none; margin-top: 20px; padding: 16px; background: #0f0f0f; border-radius: 12px; border: 1px solid #27272a;">
                    <div style="color: #a1a1aa; font-size: 13px;">
                        <span id="pagination-info">Showing 0-0 of 0</span>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button id="prev-page-btn" onclick="goToPreviousPage()" style="padding: 8px 16px; background: #18181b; color: #fff; border: 1px solid #27272a; border-radius: 8px; cursor: pointer; font-size: 13px; transition: all 0.2s;" disabled>
                            <i class="fa-solid fa-chevron-left"></i> Previous
                        </button>
                        <div id="page-numbers" style="display: flex; gap: 4px;">
                            <!-- Page numbers will be inserted here -->
                        </div>
                        <button id="next-page-btn" onclick="goToNextPage()" style="padding: 8px 16px; background: #18181b; color: #fff; border: 1px solid #27272a; border-radius: 8px; cursor: pointer; font-size: 13px; transition: all 0.2s;">
                            Next <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div id="transactions-empty-state" style="display: none; flex-direction: column; align-items: center; justify-content: center; padding: 80px 20px; text-align: center; min-height: 400px; width: 100%;">
                    <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 24px;">
                        <i class="fa-solid fa-receipt" style="font-size: 48px; color: #52525b; opacity: 0.5;"></i>
                    </div>
                    <h3 style="font-size: 24px; font-weight: 600; color: #fff; margin-bottom: 12px;">No Transactions Found</h3>
                    <p style="font-size: 14px; color: #a1a1aa; max-width: 400px; line-height: 1.6; margin: 0 auto;">
                        Start tracking your expenses and income by adding your first transaction.
                    </p>
                </div>
            </div>
    
    <!-- Lightbox for viewing attachments -->
    <div class="lightbox" id="lightbox" onclick="closeLightbox(event)">
        <button class="lightbox-close" onclick="closeLightbox()"><i class="fa-solid fa-xmark"></i></button>
        <button class="lightbox-nav prev" onclick="prevFile(event)"><i class="fa-solid fa-chevron-left"></i></button>
        <div id="lightbox-content"></div>
        <button class="lightbox-nav next" onclick="nextFile(event)"><i class="fa-solid fa-chevron-right"></i></button>
        <div class="lightbox-counter" id="lightbox-counter"></div>
    </div>

            <!-- Budget View -->
            <div id="budget" class="view">
                <div class="header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: #fff;">Budget</h2>
                </div>
                <div class="budget-grid" id="budget-grid">
                    <!-- Budget cards will be loaded here -->
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings" class="view">
                <h2 style="font-size: 20px; font-weight: 600; color: #fff; margin-bottom: 20px;">Settings</h2>
                
                <!-- Account Section -->
                <div style="background: #0f0f0f; padding: 20px; border-radius: 12px; border: 1px solid #27272a; margin-bottom: 20px;">
                    <h3 style="font-size: 16px; font-weight: 600; color: #fff; margin: 0 0 16px 0;">Account</h3>
                    
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <!-- Profile Information -->
                        <div id="profile-section" style="display: none;">
                            <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: #18181b; border-radius: 10px; border: 1px solid #27272a;">
                                <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #b5ff7d 0%, #48c6ef 100%); display: flex; align-items: center; justify-content: center; color: #000; font-weight: 600; font-size: 18px; flex-shrink: 0;" id="account-avatar">
                                    <span id="account-initial">U</span>
                                </div>
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                        <div style="font-size: 14px; font-weight: 600; color: #fff;" id="account-username">Loading...</div>
                                        <button onclick="toggleEditProfile()" id="edit-profile-btn" style="background: none; border: none; color: #a1a1aa; cursor: pointer; padding: 4px; font-size: 12px; transition: color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#a1a1aa'" title="Edit profile">
                                            <i class="fa-solid fa-pen"></i>
                                        </button>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="font-size: 12px; color: #a1a1aa;" id="account-email">Loading...</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Edit Profile Form (hidden by default) -->
                            <div id="edit-profile-form" style="display: none; margin-top: 16px; padding: 16px; background: #18181b; border-radius: 10px; border: 1px solid #27272a;">
                                <div class="input-group">
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #a1a1aa; margin-bottom: 6px;">Name</label>
                                    <input type="text" id="profile-username" placeholder="Enter your name" style="width: 100%; max-width: 300px; background: #0f0f0f; border: 2px solid transparent; padding: 10px; color: #fff; border-radius: 10px; font-size: 13px; transition: all 0.2s ease; box-sizing: border-box;" onfocus="this.style.borderColor='#b5ff7d'; this.style.outline='none';" onblur="this.style.borderColor='transparent';">
                                </div>
                                <div class="input-group" style="margin-top: 16px;">
                                    <label style="display: block; font-size: 12px; font-weight: 500; color: #a1a1aa; margin-bottom: 6px;">Email</label>
                                    <input type="email" id="profile-email" placeholder="Enter your email" style="width: 100%; max-width: 300px; background: #0f0f0f; border: 2px solid transparent; padding: 10px; color: #fff; border-radius: 10px; font-size: 13px; transition: all 0.2s ease; box-sizing: border-box;" onfocus="this.style.borderColor='#b5ff7d'; this.style.outline='none';" onblur="this.style.borderColor='transparent';">
                                </div>
                                <div style="display: flex; gap: 10px; margin-top: 16px;">
                                    <button onclick="updateProfile()" style="padding: 10px 20px; background: #3f3f46; color: #fff; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s;" onmouseover="this.style.background='#52525b'" onmouseout="this.style.background='#3f3f46'">
                                        Save
                                    </button>
                                    <button onclick="cancelEditProfile()" style="padding: 10px 20px; background: transparent; color: #a1a1aa; border: 1px solid #27272a; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s;" onmouseover="this.style.background='#27272a'; this.style.color='#fff'" onmouseout="this.style.background='transparent'; this.style.color='#a1a1aa'">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Profile Information Display (for non-local accounts or when not editing) -->
                        <div id="profile-display" style="display: flex; align-items: center; gap: 16px; padding: 16px; background: #18181b; border-radius: 10px; border: 1px solid #27272a;">
                            <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #b5ff7d 0%, #48c6ef 100%); display: flex; align-items: center; justify-content: center; color: #000; font-weight: 600; font-size: 18px; flex-shrink: 0;" id="account-avatar-display">
                                <span id="account-initial-display">U</span>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 4px;" id="account-username-display">Loading...</div>
                                <div style="font-size: 12px; color: #a1a1aa;" id="account-email-display">Loading...</div>
                            </div>
                        </div>
                        
                        <!-- Change Password (only for local accounts) -->
                        <div id="password-section" style="display: none;">
                            <div class="input-group">
                                <label style="display: block; font-size: 12px; font-weight: 500; color: #a1a1aa; margin-bottom: 6px;">Change Password</label>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <div style="position: relative; width: 100%; max-width: 300px;">
                                        <input type="password" id="current-password" placeholder="Current password" style="width: 100%; background: #18181b; border: 2px solid transparent; padding: 10px 40px 10px 10px; color: #fff; border-radius: 10px; font-size: 13px; transition: all 0.2s ease; box-sizing: border-box;" onfocus="this.style.borderColor='#b5ff7d'; this.style.outline='none';" onblur="this.style.borderColor='transparent';">
                                        <i class="fa-solid fa-eye" id="toggle-current-password" onclick="togglePasswordVisibility('current-password', 'toggle-current-password')" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #a1a1aa; cursor: pointer; font-size: 14px; transition: color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#a1a1aa'"></i>
                                    </div>
                                    <div style="position: relative; width: 100%; max-width: 300px;">
                                        <input type="password" id="new-password" placeholder="New password" style="width: 100%; background: #18181b; border: 2px solid transparent; padding: 10px 40px 10px 10px; color: #fff; border-radius: 10px; font-size: 13px; transition: all 0.2s ease; box-sizing: border-box;" onfocus="this.style.borderColor='#b5ff7d'; this.style.outline='none';" onblur="this.style.borderColor='transparent';">
                                        <i class="fa-solid fa-eye" id="toggle-new-password" onclick="togglePasswordVisibility('new-password', 'toggle-new-password')" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #a1a1aa; cursor: pointer; font-size: 14px; transition: color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#a1a1aa'"></i>
                                    </div>
                                    <div style="position: relative; width: 100%; max-width: 300px;">
                                        <input type="password" id="confirm-password" placeholder="Confirm new password" style="width: 100%; background: #18181b; border: 2px solid transparent; padding: 10px 40px 10px 10px; color: #fff; border-radius: 10px; font-size: 13px; transition: all 0.2s ease; box-sizing: border-box;" onfocus="this.style.borderColor='#b5ff7d'; this.style.outline='none';" onblur="this.style.borderColor='transparent';">
                                        <i class="fa-solid fa-eye" id="toggle-confirm-password" onclick="togglePasswordVisibility('confirm-password', 'toggle-confirm-password')" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #a1a1aa; cursor: pointer; font-size: 14px; transition: color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#a1a1aa'"></i>
                                    </div>
                                    <button onclick="changePassword()" style="width: fit-content; padding: 10px 20px; background: #3f3f46; color: #fff; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s;">
                                        Update Password
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Account Actions -->
                        <div style="border-top: 1px solid #27272a; padding-top: 16px; margin-top: 8px;">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <button onclick="confirmDeleteAccount()" style="width: fit-content; padding: 10px 20px; background: transparent; color: #ff5757; border: 1px solid #ff5757; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s;">
                                    <i class="fa-solid fa-trash" style="margin-right: 8px;"></i>Delete Account
                                </button>
                                <small style="color: #a1a1aa; font-size: 11px; margin-top: -4px;">Permanently delete your account and all associated data</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- General Settings Section -->
                <div style="background: #0f0f0f; padding: 20px; border-radius: 12px; border: 1px solid #27272a; margin-bottom: 20px;">
                    <h3 style="font-size: 16px; font-weight: 600; color: #fff; margin: 0 0 16px 0;">General Settings</h3>
                    
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <!-- Currency Selection -->
                        <div class="input-group">
                            <label style="display: block; font-size: 12px; font-weight: 500; color: #a1a1aa; margin-bottom: 6px;">Currency</label>
                            <select id="currency-select" style="width: 100%; max-width: 280px; background: #18181b; border: 2px solid transparent; padding: 10px 50px 10px 10px; color: #fff; border-radius: 10px; font-size: 13px; cursor: pointer; transition: all 0.2s ease; appearance: none; background-image: url('data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'12\' height=\'12\' viewBox=\'0 0 12 12\'%3E%3Cpath fill=\'%23a1a1aa\' d=\'M6 9L1 4h10z\'/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 18px center;" onchange="updateCurrency()">
                                <option value="MYR" selected>MYR - Malaysian Ringgit (RM)</option>
                                <option value="USD">USD - US Dollar ($)</option>
                                <option value="EUR">EUR - Euro (€)</option>
                                <option value="GBP">GBP - British Pound (£)</option>
                                <option value="SGD">SGD - Singapore Dollar (S$)</option>
                                <option value="JPY">JPY - Japanese Yen (¥)</option>
                                <option value="CNY">CNY - Chinese Yuan (¥)</option>
                                <option value="AUD">AUD - Australian Dollar (A$)</option>
                                <option value="CAD">CAD - Canadian Dollar (C$)</option>
                                <option value="INR">INR - Indian Rupee (₹)</option>
                                <option value="THB">THB - Thai Baht (฿)</option>
                                <option value="IDR">IDR - Indonesian Rupiah (Rp)</option>
                                <option value="PHP">PHP - Philippine Peso (₱)</option>
                                <option value="VND">VND - Vietnamese Dong (₫)</option>
                            </select>
                            <small style="color: #a1a1aa; font-size: 11px; margin-top: 4px; display: block;">Select your preferred currency for displaying amounts</small>
                        </div>
                        
                    </div>
                </div>
                
                <!-- Category Management Section -->
                <div style="background: #0f0f0f; padding: 20px; border-radius: 12px; border: 1px solid #27272a; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #fff; margin: 0;">Category Management</h3>
                        <button onclick="openCategoryModal()" style="background: #3f3f46; color: #fff; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                            <i class="fa-solid fa-plus"></i> Add Category
                        </button>
                    </div>
                    <div id="categories-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: 10px;">
                        <!-- Categories will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Budget Modal -->
    <div class="modal" id="budgetModal">
        <div class="modal-content budget-modal-content">
            <div class="modal-header">
                <h2>Create New Budget</h2>
                <button class="close-btn" onclick="closeBudgetModal()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="budget-modal-body">
                <div class="input-group">
                    <label>Category</label>
                    <select id="budget-category-select" class="category-select">
                        <option value="">Select a category</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Budget Amount</label>
                    <input type="number" id="budget-amount-input" placeholder="0.00" step="0.01" min="0">
                </div>
                <button class="save-btn" onclick="createBudget()">Create Budget</button>
            </div>
        </div>
    </div>

    <!-- Modal Backdrop -->
    <div class="modal-backdrop" id="modal-backdrop"></div>
    
    <!-- Budget Detail Modal -->
    <div class="modal" id="budgetDetailModal" style="display: none;">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h2 id="budget-detail-title" style="flex: 1;">Budget Details</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button onclick="confirmDeleteBudget()" style="padding: 4px 12px; height: 28px; background: #3f3f46; color: #fff; border: 1px solid #52525b; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s; display: flex; align-items: center; gap: 6px; box-sizing: border-box;" onmouseover="this.style.background='#52525b'; this.style.borderColor='#71717a'" onmouseout="this.style.background='#3f3f46'; this.style.borderColor='#52525b'">
                        <i class="fa-solid fa-trash"></i> Delete
                    </button>
                    <button class="close-btn" onclick="closeBudgetDetailModal()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <!-- Budget Info Section -->
                <div style="background: #18181b; padding: 16px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #27272a;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div>
                            <h3 style="font-size: 18px; font-weight: 600; color: #fff; margin: 0 0 8px 0;" id="budget-detail-category">Category</h3>
                            <div style="font-size: 13px; color: #a1a1aa;" id="budget-detail-stats">0 Items</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 12px; color: #a1a1aa; margin-bottom: 4px;">Total Budget</div>
                            <div style="font-size: 20px; font-weight: 600; color: #fff;" id="budget-detail-amount">RM 0.00</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 20px; margin-bottom: 12px;">
                        <div style="flex: 1;">
                            <div style="font-size: 12px; color: #a1a1aa; margin-bottom: 4px;">Spent</div>
                            <div style="font-size: 16px; font-weight: 600; color: #ff5757;" id="budget-detail-spent">RM 0.00</div>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 12px; color: #a1a1aa; margin-bottom: 4px;">Remaining</div>
                            <div style="font-size: 16px; font-weight: 600; color: #b5ff7d;" id="budget-detail-remaining">RM 0.00</div>
                        </div>
                    </div>
                    <div class="budget-progress-bar" style="height: 8px; background: #27272a; border-radius: 4px; overflow: hidden;">
                        <div class="budget-progress-fill" id="budget-detail-progress" style="height: 100%; background: linear-gradient(90deg, #b5ff7d 0%, #48c6ef 100%); transition: width 0.3s;"></div>
                    </div>
                </div>

                <!-- Edit Budget Section -->
                <div style="background: #18181b; padding: 16px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #27272a;">
                    <h4 style="font-size: 14px; font-weight: 600; color: #fff; margin: 0 0 12px 0;">Edit Budget Amount</h4>
                    <div class="input-group">
                        <label style="font-size: 12px; color: #a1a1aa;">New Budget Amount</label>
                        <input type="number" id="budget-edit-amount" placeholder="0.00" step="0.01" min="0" style="width: 100%; background: #0f0f0f; border: 1px solid #27272a; padding: 10px; color: #fff; border-radius: 8px; font-size: 13px;">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 12px;">
                        <button onclick="updateBudgetAmount()" style="flex: 1; padding: 10px; background: linear-gradient(90deg, #b5ff7d 0%, #48c6ef 100%); color: #000; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s;">
                            <i style="margin-right: 6px;"></i>Update Budget
                        </button>
                    </div>
                </div>

                <!-- Transactions List Section -->
                <div>
                    <h4 style="font-size: 14px; font-weight: 600; color: #fff; margin: 0 0 12px 0;">Transactions in this Category</h4>
                    <div id="budget-transactions-list" style="background: #18181b; border-radius: 10px; border: 1px solid #27272a; overflow: hidden;">
                        <div style="padding: 20px; text-align: center; color: #a1a1aa; font-size: 13px;">
                            <i class="fa-solid fa-spinner fa-spin" style="margin-right: 8px;"></i>Loading transactions...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transaction Modal -->
    <div class="modal" id="txnModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Transaction</h2>
                <button class="close-btn" onclick="closeModal()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Expense / Income Tabs - At Top -->
                <div class="tab-wrapper">
                    <button type="button" class="tab-btn active" id="tab-expense" onclick="setTxnType('EXPENSE')">Expense</button>
                    <button type="button" class="tab-btn" id="tab-income" onclick="setTxnType('INCOME')">Income</button>
                </div>

                <!-- Amount and Category Side by Side -->
                <div class="input-row" id="amount-category-row">
                    <div class="input-group" id="amount-group">
                        <label>Amount</label>
                        <input type="number" id="amount-input" class="amount-input" placeholder="0.00" step="0.01" min="0">
                    </div>
                    <div class="input-group" id="category-group">
                        <label>Category</label>
                        <div class="category-dropdown-wrapper">
                            <select id="category-select" class="category-select">
                                <option value="">Select a category</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="input-group">
                    <label>Description</label>
                    <input type="text" id="desc" placeholder="What is this for?">
                </div>

                <!-- Date -->
                <div class="input-group">
                    <label>Date</label>
                    <input type="date" id="date">
                </div>

                <!-- Recurring Section -->
                <div class="recurring-section">
                    <div class="recurring-toggle-wrapper">
                        <label class="recurring-toggle-label">Make this recurring</label>
                        <div class="toggle-button" id="recurring-toggle-btn" onclick="toggleRecurring()"></div>
                    </div>
                    <div class="recurring-options" id="recurring-options">
                        <div class="input-group" style="margin-bottom: 12px;">
                            <label>Repeat</label>
                            <select id="recurring-frequency">
                                <option value="DAILY">Daily</option>
                                <option value="WEEKLY">Weekly</option>
                                <option value="MONTHLY">Monthly</option>
                                <option value="YEARLY">Yearly</option>
                            </select>
                        </div>
                        <div class="input-group" style="margin-bottom: 12px;">
                            <label>End Date <span style="color: #ff5757;">*</span></label>
                            <input type="date" id="recurring-end-date">
                        </div>
                    </div>
                </div>

                <!-- Attachments - Minimal -->
                <div class="attachment-section">
                    <label class="attachment-label">Attachments</label>
                    <div class="attachment-minimal" id="dropzone" onclick="document.getElementById('file-input').click()">
                        <i class="fa-solid fa-paperclip"></i>
                        <span id="attachment-text">Click to add files or drag & drop</span>
                    </div>
                    <input type="file" id="file-input" class="attachment-input" multiple accept="image/*,.pdf,.doc,.docx">
                    <div class="attachment-preview" id="attachment-preview"></div>
                </div>

                <!-- Submit Button -->
                <button class="save-btn" onclick="submitTransaction()">Add Transaction</button>
            </div>
        </div>
    </div>

    <!-- Category Management Modal -->
    <div class="modal" id="categoryModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="category-modal-title">Add Category</h2>
                <button class="close-btn" onclick="closeCategoryModal()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>Category Name</label>
                    <input type="text" id="category-name-input" placeholder="Enter category name" style="width: 100%; background: #18181b; border: 2px solid transparent; padding: 12px; color: #fff; border-radius: 10px; transition: all 0.2s ease; font-size: 13px;">
                </div>
                
                <div class="input-group">
                    <label>Icon</label>
                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; max-height: 200px; overflow-y: auto; padding: 8px; background: #18181b; border-radius: 12px; border: 2px solid transparent;">
                        <!-- Icons will be populated by JavaScript -->
                    </div>
                    <input type="hidden" id="category-icon-input" value="fa-circle-question">
                </div>
                
                <div class="input-group">
                    <label>Color</label>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <input type="color" id="category-color-input" value="#52525b" style="width: 60px; height: 40px; border: none; border-radius: 8px; cursor: pointer; background: #18181b;">
                        <input type="text" id="category-color-hex" value="#52525b" placeholder="#52525b" style="flex: 1; background: #18181b; border: 2px solid transparent; padding: 14px; color: #fff; border-radius: 12px; font-size: 14px;">
                    </div>
                </div>
                
                <button class="save-btn" onclick="saveCategory()" id="category-save-btn">Add Category</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Export Data</h2>
                <button class="close-btn" onclick="closeExportModal()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; gap: 20px;">
                <div class="input-group">
                    <label>Type & Category Filter</label>
                    <select id="export-filter-type-category" class="category-select">
                        <option value="">All Types & Categories</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Date Range</label>
                    <select id="export-filter-date-range" class="category-select" onchange="handleExportDateRangeChange()">
                        <option value="all">All Time</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="custom">Custom Date Range</option>
                    </select>
                </div>
                <div id="export-custom-date-range">
                    <input type="date" id="export-date-from">
                    <span style="color: #a1a1aa;">to</span>
                    <input type="date" id="export-date-to">
                </div>
                <div class="input-group">
                    <label>Export Format</label>
                    <div style="display: flex; gap: 12px; margin-top: 8px;">
                        <button onclick="performExport('pdf')" class="export-btn" style="flex: 1; justify-content: center;">
                            <i class="fa-solid fa-file-pdf"></i> PDF
                        </button>
                        <button onclick="performExport('excel')" class="export-btn" style="flex: 1; justify-content: center;">
                            <i class="fa-solid fa-file-excel"></i> Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Dialog Modals -->
    <div class="dialog-modal" id="confirmDialog">
        <div class="dialog-content">
            <div class="dialog-title" id="confirmTitle">Confirm</div>
            <div class="dialog-message" id="confirmMessage"></div>
            <div class="dialog-buttons">
                <button class="dialog-btn dialog-btn-secondary" onclick="closeConfirmDialog(false)">Cancel</button>
                <button class="dialog-btn dialog-btn-primary" onclick="closeConfirmDialog(true)">OK</button>
            </div>
        </div>
    </div>

    <div class="dialog-modal" id="alertDialog">
        <div class="dialog-content">
            <div class="dialog-title" id="alertTitle">Alert</div>
            <div class="dialog-message" id="alertMessage"></div>
            <div class="dialog-buttons">
                <button class="dialog-btn dialog-btn-primary" onclick="closeAlertDialog()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // CRITICAL: Log that script is executing
        console.log('=== DASHBOARD SCRIPT LOADING ===');
        console.log('Script execution started at:', new Date().toISOString());
        
        // API Configuration
        const API_BASE_URL = 'http://localhost:8080';
        console.log('API_BASE_URL set to:', API_BASE_URL);
        
        // Helper function to get token dynamically
        function getToken() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                console.error('No JWT token found in localStorage');
                return null;
            }
            return token;
        }
        
        // Check token on page load
        console.log('Checking for token in localStorage...');
        const token = getToken();
        if (!token) {
            console.error('No JWT token found in localStorage. Redirecting to login...');
            window.location.href = 'index.html';
        } else {
            console.log('JWT token found in localStorage, length:', token.length);
        }
        
        console.log('=== SCRIPT INITIALIZATION COMPLETE ===');

        // Custom Dialog Functions
        let confirmCallback = null;
        
        function showConfirmDialog(message, title = 'Confirm', callback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmDialog').style.display = 'flex';
            confirmCallback = callback;
        }
        
        function closeConfirmDialog(result) {
            document.getElementById('confirmDialog').style.display = 'none';
            if (confirmCallback) {
                confirmCallback(result);
                confirmCallback = null;
            }
        }
        
        function showAlertDialog(message, title = 'Alert', callback) {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertDialog').style.display = 'flex';
            if (callback) {
                const okBtn = document.querySelector('#alertDialog .dialog-btn-primary');
                okBtn.onclick = () => {
                    closeAlertDialog();
                    callback();
                };
            }
        }
        
        function closeAlertDialog() {
            document.getElementById('alertDialog').style.display = 'none';
        }
        
        // Close dialogs on backdrop click
        document.getElementById('confirmDialog').addEventListener('click', (e) => {
            if (e.target.id === 'confirmDialog') {
                closeConfirmDialog(false);
            }
        });
        
        document.getElementById('alertDialog').addEventListener('click', (e) => {
            if (e.target.id === 'alertDialog') {
                closeAlertDialog();
            }
        });

        let currentModalType = 'EXPENSE';
        let selectedCategory = '';
        let allCategories = [];
        let selectedFiles = [];
        let isRecurring = false;
        let allTransactions = []; // Store all transactions for filtering
        let currentPage = 1; // Current page for pagination
        const itemsPerPage = 10; // Number of items per page
        let isDeleting = false; // Flag to prevent refreshData from interfering with deletions
        
        // User settings
        let userCurrency = 'MYR'; // Default currency
        // Use default date format (DD/MM/YYYY) - no user selection needed
        
        // Currency symbols mapping
        const currencySymbols = {
            'MYR': 'RM',
            'USD': '$',
            'EUR': '€',
            'GBP': '£',
            'SGD': 'S$',
            'JPY': '¥',
            'CNY': '¥',
            'AUD': 'A$',
            'CAD': 'C$',
            'INR': '₹',
            'THB': '฿',
            'IDR': 'Rp',
            'PHP': '₱',
            'VND': '₫'
        };
        
        // Format currency amount
        function formatCurrency(amount) {
            if (amount == null || amount === undefined) return currencySymbols[userCurrency] + '0.00';
            const symbol = currencySymbols[userCurrency] || userCurrency;
            return symbol + amount.toFixed(2);
        }

        // Test: Verify window.onload is being set
        console.log('Setting window.onload handler...');
        
        window.onload = async () => {
            console.log('=== DASHBOARD PAGE LOADED ===');
            console.log('Window.onload executing at:', new Date().toISOString());
            console.log('Document ready state:', document.readyState);
            
            
            // Verify token is available before making requests
            const currentToken = getToken();
            if (!currentToken) {
                console.error('No token found in localStorage! Redirecting to login...');
                showAlertDialog('No authentication token found. Please log in again.', 'Authentication Required');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }
            
            console.log('=== DASHBOARD INITIALIZATION ===');
            console.log('Token verified, length:', currentToken.length);
            console.log('Token preview:', currentToken.substring(0, 30) + '...');
            console.log('API Base URL:', API_BASE_URL);
            console.log('Current page URL:', window.location.href);
            console.log('Starting data load sequence...');
            
            // Test: Verify token can be retrieved again
            const testToken = getToken();
            console.log('Test: getToken() returns token:', !!testToken, testToken ? testToken.length : 0);
            
            // CRITICAL TEST: Make a simple fetch call IMMEDIATELY to verify network is working
            console.log('=== NETWORK CONNECTIVITY TEST ===');
            console.log('Making test fetch to:', `${API_BASE_URL}/api/user`);
            console.log('With token length:', currentToken.length);
            
            try {
                const testResponse = await fetch(`${API_BASE_URL}/api/user`, {
                    method: 'GET',
                    headers: { 
                        'Authorization': 'Bearer ' + currentToken,
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'include'
                });
                console.log('✓ Network test SUCCESS - Response status:', testResponse.status);
                console.log('Response statusText:', testResponse.statusText);
                console.log('Response headers:', Object.fromEntries([...testResponse.headers.entries()]));
                
                if (testResponse.ok) {
                    const userData = await testResponse.json();
                    console.log('✓ User data received:', userData);
                } else {
                    const errorText = await testResponse.text();
                    console.error('✗ Network test returned error:', testResponse.status, errorText);
                }
            } catch (testError) {
                console.error('✗✗✗ NETWORK TEST FAILED ✗✗✗');
                console.error('Error name:', testError.name);
                console.error('Error message:', testError.message);
                console.error('Error stack:', testError.stack);
                console.error('This means fetch() is not working. Check CORS, network, or browser console.');
                alert('Network test failed: ' + testError.message + '\nCheck browser console for details.');
            }
            
            // Load all data (user info, transactions, categories, etc.)
            // Load user info first, then other data
            console.log('Calling loadUserInfo()...');
            try {
                await loadUserInfo();
                console.log('✓ User info loaded successfully');
            } catch (error) {
                console.error('✗ Error loading user info:', error);
                console.error('Error stack:', error.stack);
            }
            
            console.log('Calling refreshData()...');
            try {
                await refreshData();
                console.log('✓ Transactions loaded successfully');
            } catch (error) {
                console.error('✗ Error loading transactions:', error);
                console.error('Error stack:', error.stack);
            }
            
            console.log('Calling loadCategories()...');
            try {
                await loadCategories();
                console.log('✓ Categories loaded successfully');
            } catch (error) {
                console.error('✗ Error loading categories:', error);
            }
            
            document.getElementById('date').valueAsDate = new Date();
            setupAttachments();
            
            
            console.log('=== INITIALIZATION COMPLETE ===');
            
            // Initialize sidebar indicator position
            const activeItem = document.querySelector('.sidebar-item.active');
            if (activeItem) {
                const indicator = document.getElementById('sidebar-indicator');
                const sidebarContainer = document.querySelector('.sidebar');
                if (indicator && sidebarContainer) {
                    const containerRect = sidebarContainer.getBoundingClientRect();
                    const itemRect = activeItem.getBoundingClientRect();
                    const itemTop = itemRect.top - containerRect.top;
                    indicator.style.top = itemTop + 'px';
                }
            }
            
            // Initialize overview view
            switchView('overview', activeItem);
        };

        let categoryChart = null;
        let monthlyChart = null;

        // Update Monthly Income & Expenses Bar Chart
        function updateMonthlyChart(transactions) {
            const ctx = document.getElementById('monthlyChart');
            if (!ctx) return;

            // Group transactions by month
            const monthlyData = {};
            
            transactions.forEach(t => {
                if (!t.date) return;
                
                const date = new Date(t.date + 'T00:00:00');
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthLabel = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        label: monthLabel,
                        income: 0,
                        expense: 0
                    };
                }
                
                if (t.type === 'INCOME') {
                    monthlyData[monthKey].income += t.amount || 0;
                } else if (t.type === 'EXPENSE') {
                    monthlyData[monthKey].expense += t.amount || 0;
                }
            });

            // Sort by month key (chronologically)
            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(key => monthlyData[key].label);
            const incomeData = sortedMonths.map(key => monthlyData[key].income);
            const expenseData = sortedMonths.map(key => monthlyData[key].expense);

            // Destroy previous chart if exists
            if (monthlyChart) {
                monthlyChart.destroy();
                monthlyChart = null;
            }

            // Show empty state if no data
            if (labels.length === 0) {
                monthlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['No data available'],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        },
                        scales: {
                            y: { display: false },
                            x: { display: false }
                        }
                    }
                });
                return;
            }

            // Create bar chart
            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Income',
                            data: incomeData,
                            backgroundColor: '#b5ff7d',
                            borderColor: '#b5ff7d',
                            borderWidth: 0,
                            borderRadius: 6
                        },
                        {
                            label: 'Expenses',
                            data: expenseData,
                            backgroundColor: '#ff5757',
                            borderColor: '#ff5757',
                            borderWidth: 0,
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#fff',
                                font: {
                                    size: 12,
                                    family: "'DM Sans', sans-serif"
                                },
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: '#18181b',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#27272a',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: false,
                            grid: {
                                color: '#27272a',
                                display: true
                            },
                            ticks: {
                                color: '#a1a1aa',
                                font: {
                                    size: 11,
                                    family: "'DM Sans', sans-serif"
                                }
                            }
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            grid: {
                                color: '#27272a',
                                display: true
                            },
                            ticks: {
                                color: '#a1a1aa',
                                font: {
                                    size: 11,
                                    family: "'DM Sans', sans-serif"
                                },
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function switchView(viewId, element) {
            // Update sidebar indicator position
            const indicator = document.getElementById('sidebar-indicator');
            
            // Update active sidebar item
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            
            let activeItem = element;
            if (!activeItem) {
                // Find element by data-view attribute
                activeItem = document.querySelector(`.sidebar-item[data-view="${viewId}"]`);
            }
            
            if (activeItem && indicator) {
                activeItem.classList.add('active');
                // Calculate position relative to the sidebar container
                const sidebarContainer = document.querySelector('.sidebar');
                
                if (sidebarContainer) {
                    const containerRect = sidebarContainer.getBoundingClientRect();
                    const itemRect = activeItem.getBoundingClientRect();
                    
                    // Calculate position relative to sidebar container
                    const itemTop = itemRect.top - containerRect.top;
                    indicator.style.top = itemTop + 'px';
                } else {
                    // Fallback to offsetTop
                    indicator.style.top = activeItem.offsetTop + 'px';
                }
            }

            // Update view - hide all views first with !important
            document.querySelectorAll('.view').forEach(v => {
                v.classList.remove('active');
                v.style.setProperty('display', 'none', 'important');
                v.style.setProperty('visibility', 'hidden', 'important');
                v.style.setProperty('height', '0', 'important');
                v.style.setProperty('min-height', '0', 'important');
                v.style.setProperty('overflow', 'hidden', 'important');
                v.style.setProperty('margin', '0', 'important');
                v.style.setProperty('padding', '0', 'important');
            });
            const viewElement = document.getElementById(viewId);
            if (viewElement) {
                viewElement.classList.add('active');
                // Restore normal styles for active view
                viewElement.style.removeProperty('display');
                viewElement.style.removeProperty('visibility');
                viewElement.style.removeProperty('height');
                viewElement.style.removeProperty('min-height');
                viewElement.style.removeProperty('overflow');
                viewElement.style.setProperty('display', 'block', 'important');
                
                // No special handling needed - exports view now matches settings view structure
            } else {
                console.error(`View with id "${viewId}" not found`);
                return;
            }
            
            // Load budgets when budget view is shown
            if (viewId === 'budget') {
                loadBudgets();
            }
            
            // Load export history when exports view is shown
            if (viewId === 'exports') {
                loadExportHistory();
            }
            
            // Load categories when settings view is shown
            if (viewId === 'settings') {
                loadCategoriesList();
            }
            
            // Update charts when overview is shown
            if (viewId === 'overview') {
                updateCategoryChart();
                // Also update upcoming expense chart if we have transactions
                if (window.allTransactions && window.allTransactions.length > 0) {
                    updateUpcomingBillsChart(window.allTransactions);
                }
            }
        }

        // Recurring Toggle
        function toggleRecurring() {
            const toggleBtn = document.getElementById('recurring-toggle-btn');
            isRecurring = !isRecurring;
            const options = document.getElementById('recurring-options');
            const endDateInput = document.getElementById('recurring-end-date');
            
            if (isRecurring) {
                toggleBtn.classList.add('active');
                options.classList.add('active');
                // Make end date required when recurring is enabled
                if (endDateInput) {
                    endDateInput.setAttribute('required', 'required');
                }
            } else {
                toggleBtn.classList.remove('active');
                options.classList.remove('active');
                // Remove required attribute when recurring is disabled
                if (endDateInput) {
                    endDateInput.removeAttribute('required');
                }
            }
        }

        // Attachment Handling
        function setupAttachments() {
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('file-input');

            // Drag and drop events
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('dragover');
            });

            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('dragover');
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
                fileInput.value = ''; // Reset to allow selecting same file again
            });
        }

        function updateAttachmentText() {
            const textEl = document.getElementById('attachment-text');
            if (selectedFiles.length === 0) {
                textEl.textContent = 'Click to add files or drag & drop';
            } else {
                textEl.textContent = `${selectedFiles.length} file${selectedFiles.length > 1 ? 's' : ''} selected`;
            }
        }

        function handleFiles(files) {
            const maxSize = 5 * 1024 * 1024; // 5MB
            
            Array.from(files).forEach(file => {
                if (file.size > maxSize) {
                    showAlertDialog(`${file.name} is too large. Max size is 5MB.`, 'File Too Large');
                    return;
                }
                if (selectedFiles.length >= 5) {
                    showAlertDialog('Maximum 5 attachments allowed.', 'Limit Reached');
                    return;
                }
                selectedFiles.push(file);
            });
            
            updateAttachmentText();
            renderAttachmentPreview();
        }

        function renderAttachmentPreview() {
            const preview = document.getElementById('attachment-preview');
            
            const totalFiles = keptExistingAttachments.length + selectedFiles.length;
            
            if (totalFiles === 0) {
                preview.classList.remove('has-files');
                preview.innerHTML = '';
                
                // Update attachment text
                const textEl = document.getElementById('attachment-text');
                if (textEl) {
                    textEl.textContent = 'Click to add files or drag & drop';
                }
                return;
            }
            
            preview.classList.add('has-files');
            
            // Render existing attachments first (when editing)
            let html = '';
            if (keptExistingAttachments.length > 0) {
                html += keptExistingAttachments.map((url, index) => {
                    const fileName = url.split('/').pop();
                    const isPdf = fileName.toLowerCase().endsWith('.pdf');
                    const icon = isPdf ? 'fa-file-pdf' : 'fa-image';
                    
                    return `
                        <div class="attachment-item" data-existing-index="${index}">
                            <i class="fa-solid ${icon}"></i>
                            <div class="file-info">
                                <span class="file-name" title="${fileName}">${fileName}</span>
                                <span class="file-size">Existing</span>
                            </div>
                            <button type="button" class="remove-btn" onclick="removeExistingAttachment(${index})">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    `;
                }).join('');
            }
            
            // Render new files
            html += selectedFiles.map((file, index) => {
                const icon = getFileIcon(file.type);
                const size = formatFileSize(file.size);
                
                return `
                    <div class="attachment-item" data-new-index="${index}">
                        <i class="fa-solid ${icon}"></i>
                        <div class="file-info">
                            <span class="file-name" title="${file.name}">${file.name}</span>
                            <span class="file-size">${size}</span>
                        </div>
                        <button type="button" class="remove-btn" onclick="removeAttachment(${index})">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                `;
            }).join('');
            
            preview.innerHTML = html;
            
            // Update attachment text
            const textEl = document.getElementById('attachment-text');
            if (textEl) {
                textEl.textContent = `${totalFiles} file${totalFiles > 1 ? 's' : ''} selected`;
            }
        }

        function removeAttachment(index) {
            selectedFiles.splice(index, 1);
            renderAttachmentPreview();
        }
        
        function removeExistingAttachment(index) {
            keptExistingAttachments.splice(index, 1);
            renderAttachmentPreview();
        }

        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return 'fa-image';
            if (mimeType === 'application/pdf') return 'fa-file-pdf';
            if (mimeType.includes('word') || mimeType.includes('document')) return 'fa-file-word';
            return 'fa-file';
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Transaction Type
        function setTxnType(type) {
            currentModalType = type;
            document.getElementById('tab-expense').classList.toggle('active', type === 'EXPENSE');
            document.getElementById('tab-income').classList.toggle('active', type === 'INCOME');
            
            // Hide/show category field based on transaction type
            const categoryGroup = document.getElementById('category-group');
            const amountCategoryRow = document.getElementById('amount-category-row');
            
            if (!categoryGroup || !amountCategoryRow) {
                console.error('Category group or amount row not found!');
                return;
            }
            
            if (type === 'INCOME') {
                // Hide category for income
                categoryGroup.classList.add('hidden');
                categoryGroup.style.display = 'none'; // Force hide with inline style
                amountCategoryRow.classList.add('amount-only');
                // Clear category selection
                const categorySelect = document.getElementById('category-select');
                if (categorySelect) {
                    categorySelect.value = '';
                }
                selectedCategory = '';
                console.log('Income selected - category hidden');
            } else {
                // Show category for expense
                categoryGroup.classList.remove('hidden');
                categoryGroup.style.display = 'block'; // Force show with inline style
                amountCategoryRow.classList.remove('amount-only');
                console.log('Expense selected - category shown');
            }
        }

        // Category Selection
        function selectCategory() {
            const select = document.getElementById('category-select');
            selectedCategory = select.value;
        }

        async function refreshData() {
            // Don't refresh if we're in the middle of a deletion (to prevent overwriting immediate updates)
            if (isDeleting) {
                console.log('Skipping refreshData() - deletion in progress');
                return;
            }
            
            try {
                const currentToken = getToken();
                if (!currentToken) {
                    console.error('No token available for transactions request');
                    showAlertDialog('Authentication token missing. Please log in again.', 'Authentication Error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return;
                }
                
                console.log('=== FETCHING TRANSACTIONS ===');
                console.log('URL:', `${API_BASE_URL}/api/transactions`);
                console.log('Token present:', !!currentToken);
                console.log('Token length:', currentToken.length);
                console.log('Token preview:', currentToken.substring(0, 30) + '...');
                
                const res = await fetch(`${API_BASE_URL}/api/transactions`, {
                    method: 'GET',
                    headers: { 
                        'Authorization': 'Bearer ' + currentToken,
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'include'
                });
                
                console.log('Transactions response status:', res.status, res.statusText);
                console.log('Response headers:', [...res.headers.entries()]);
                
                if (res.status === 403) {
                    console.error('403 Forbidden - Authentication failed');
                    showConfirmDialog('Session expired. Log in again?', 'Session Expired', (result) => {
                        if (result) {
                            localStorage.removeItem('jwtToken');
                            window.location.href = 'index.html';
                        }
                    });
                    return;
                }
                
                if (res.status === 401) {
                    console.error('401 Unauthorized - Invalid token');
                    showAlertDialog('Authentication failed. Please log in again.', 'Authentication Error');
                    setTimeout(() => {
                        localStorage.removeItem('jwtToken');
                        window.location.href = 'index.html';
                    }, 2000);
                    return;
                }
                
                if (!res.ok) {
                    const errorText = await res.text().catch(() => 'No error details');
                    console.error('Failed to fetch transactions:', res.status, res.statusText, errorText);
                    // Clear UI if fetch fails to prevent showing stale data
                    allTransactions = [];
                window.allTransactions = [];
                    applyFilters();
                    return;
                }
                
                const data = await res.json();
                allTransactions = data; // Store all transactions
                window.allTransactions = data; // Store globally for filter access
                
                // Use applyFilters() which handles pagination
                applyFilters();
                
                // Update category chart with all data (not paginated)
                const filteredData = applyFiltersToData(allTransactions);
                updateCategoryChart(filteredData);
                
                // Update monthly bar chart
                updateMonthlyChart(allTransactions);
                
                // Update upcoming expense chart
                updateUpcomingBillsChart(allTransactions);
                window.allTransactions = allTransactions; // Store globally for filter access
                
                // Check for upcoming subscriptions
            } catch (error) {
                console.error('Error fetching transactions:', error);
                console.error('Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                
                // Clear UI on error to prevent showing stale data
                allTransactions = [];
                window.allTransactions = [];
                applyFilters();
                
                let errorMessage = 'Failed to load transactions. ';
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    errorMessage += `Cannot connect to server at ${API_BASE_URL}. `;
                    errorMessage += 'This usually means: 1) Server is not running, 2) Wrong port, 3) CORS blocked, or 4) Network issue. ';
                    errorMessage += `Current page origin: ${window.location.origin}`;
                } else if (error.message) {
                    errorMessage += error.message;
                } else {
                    errorMessage += 'Please check if the server is running.';
                }
                showAlertDialog(errorMessage, 'Connection Error');
            }
        }

        // Filter Functions
        function applyFiltersToData(data) {
            let filtered = [...data];
            
            // Search filter
            const searchTerm = document.getElementById('search-transactions').value.toLowerCase().trim();
            if (searchTerm) {
                filtered = filtered.filter(t => 
                    t.description?.toLowerCase().includes(searchTerm) ||
                    t.category?.toLowerCase().includes(searchTerm) ||
                    t.amount?.toString().includes(searchTerm)
                );
            }
            
            // Type/Category filter
            const typeCategoryFilter = document.getElementById('filter-type-category').value;
            if (typeCategoryFilter) {
                if (typeCategoryFilter === 'EXPENSE' || typeCategoryFilter === 'INCOME') {
                    filtered = filtered.filter(t => t.type === typeCategoryFilter);
                } else {
                    // It's a category
                    filtered = filtered.filter(t => t.category === typeCategoryFilter);
                }
            }
            
            // Date range filter
            const dateRange = document.getElementById('filter-date-range').value;
            if (dateRange !== 'all') {
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Set to start of day
                
                if (dateRange === 'week') {
                    // Get start of current week (Sunday)
                    const startOfWeek = new Date(today);
                    const day = startOfWeek.getDay();
                    const diff = startOfWeek.getDate() - day; // Get Sunday
                    startOfWeek.setDate(diff);
                    startOfWeek.setHours(0, 0, 0, 0);
                    
                    // End of week is today
                    const endOfWeek = new Date(today);
                    endOfWeek.setHours(23, 59, 59, 999);
                    
                    filtered = filtered.filter(t => {
                        const tDate = new Date(t.date + 'T00:00:00'); // Parse date string properly
                        return tDate >= startOfWeek && tDate <= endOfWeek;
                    });
                } else if (dateRange === 'month') {
                    // Get start of current month
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    startOfMonth.setHours(0, 0, 0, 0);
                    
                    // End of month is today
                    const endOfMonth = new Date(today);
                    endOfMonth.setHours(23, 59, 59, 999);
                    
                    filtered = filtered.filter(t => {
                        const tDate = new Date(t.date + 'T00:00:00'); // Parse date string properly
                        return tDate >= startOfMonth && tDate <= endOfMonth;
                    });
                } else if (dateRange === 'custom') {
                    const dateFrom = document.getElementById('date-from').value;
                    const dateTo = document.getElementById('date-to').value;
                    if (dateFrom) {
                        const fromDate = new Date(dateFrom + 'T00:00:00');
                        filtered = filtered.filter(t => {
                            const tDate = new Date(t.date + 'T00:00:00');
                            return tDate >= fromDate;
                        });
                    }
                    if (dateTo) {
                        const toDate = new Date(dateTo + 'T23:59:59');
                        filtered = filtered.filter(t => {
                            const tDate = new Date(t.date + 'T00:00:00');
                            return tDate <= toDate;
                        });
                    }
                }
            }
            
            return filtered;
        }

        // Track previous filter state to detect changes
        let previousFilterState = '';
        
        // Date sort order: 'asc' = oldest to newest (default), 'desc' = newest to oldest
        let dateSortOrder = 'asc';
        
        function toggleDateSort() {
            // Toggle between 'asc' and 'desc'
            dateSortOrder = dateSortOrder === 'asc' ? 'desc' : 'asc';
            
            // Update arrow icon
            const sortIcon = document.getElementById('date-sort-icon');
            if (sortIcon) {
                if (dateSortOrder === 'asc') {
                    sortIcon.className = 'fa-solid fa-arrow-up';
                } else {
                    sortIcon.className = 'fa-solid fa-arrow-down';
                }
            }
            
            // Reapply filters with new sort order
            applyFilters(false);
        }
        
        function applyFilters(resetPage = true) {
            // Handle empty transactions case
            if (allTransactions.length === 0) {
                const table = document.getElementById('transactions-table');
                const emptyState = document.getElementById('transactions-empty-state');
                const paginationControls = document.getElementById('pagination-controls');
                
                if (table) table.style.display = 'none';
                if (emptyState) emptyState.style.display = 'flex';
                if (paginationControls) paginationControls.style.display = 'none';
                document.getElementById('txn-tbody').innerHTML = '';
                
                // Reset totals
                document.getElementById('dash-income').innerText = formatCurrency(0);
                document.getElementById('dash-expense').innerText = formatCurrency(0);
                
                // Reset select all checkbox
                document.getElementById('select-all-checkbox').checked = false;
                updateSelectedCount();
                return;
            }
            
            const filteredData = applyFiltersToData(allTransactions);
            
            // Sort by date based on current sort order
            filteredData.sort((a, b) => {
                const dateA = new Date(a.date + 'T00:00:00');
                const dateB = new Date(b.date + 'T00:00:00');
                if (dateSortOrder === 'asc') {
                    return dateA - dateB; // Oldest first
                } else {
                    return dateB - dateA; // Newest first
                }
            });
            
            // Get current filter state
            const currentFilterState = JSON.stringify({
                search: document.getElementById('search-transactions').value,
                typeCategory: document.getElementById('filter-type-category').value,
                dateRange: document.getElementById('filter-date-range').value,
                dateFrom: document.getElementById('date-from').value,
                dateTo: document.getElementById('date-to').value
            });
            
            // Reset to page 1 only if filters actually changed or if explicitly requested
            if (resetPage && currentFilterState !== previousFilterState) {
                currentPage = 1;
                previousFilterState = currentFilterState;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = filteredData.slice(startIndex, endIndex);
            
            // Calculate totals from ALL filtered data (not just current page)
            let inc = 0, exp = 0;
            filteredData.forEach(t => {
                if (t.type === 'INCOME') inc += t.amount; else exp += t.amount;
            });
            
            let rows = "";
            paginatedData.forEach(t => {
                const hasAttachment = t.receiptImage && t.receiptImage.length > 0;
                const attachmentHtml = hasAttachment 
                    ? `<span class="attachment-badge" onclick="viewAttachments('${t.receiptImage}')"><i class="fa-solid fa-paperclip"></i> View</span>`
                    : '<span style="color:#52525b">—</span>';
                const categoryHtml = t.category 
                    ? t.category 
                    : (t.type === 'INCOME' ? '<span style="color:#52525b">-</span>' : '<span style="color:#52525b">—</span>');
                rows += `<tr data-transaction-id="${t.id}">
                    <td class="checkbox-cell"><input type="checkbox" class="transaction-checkbox" value="${t.id}" onchange="updateSelectedCount()"></td>
                    <td style="color:${t.type==='EXPENSE'?'#ff5757':'#b5ff7d'}; font-weight:600;">${t.type}</td>
                    <td>${categoryHtml}</td>
                    <td>${t.description}</td>
                    <td>${formatCurrency(t.amount)}</td>
                    <td>${t.date}</td>
                    <td>${attachmentHtml}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick="editTransaction(${t.id})" title="Edit">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteTransaction(${t.id}); event.stopPropagation();" title="Delete">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            });

            document.getElementById('dash-income').innerText = formatCurrency(inc);
            document.getElementById('dash-expense').innerText = formatCurrency(exp);
            
            // Show/hide table or empty state
            const table = document.getElementById('transactions-table');
            const emptyState = document.getElementById('transactions-empty-state');
            const paginationControls = document.getElementById('pagination-controls');
            
            if (filteredData.length === 0) {
                // Show empty state, hide table and pagination
                if (table) table.style.display = 'none';
                if (emptyState) emptyState.style.display = 'flex';
                if (paginationControls) paginationControls.style.display = 'none';
                document.getElementById('txn-tbody').innerHTML = '';
            } else {
                // Show table, hide empty state
                if (table) table.style.display = 'table';
                if (emptyState) emptyState.style.display = 'none';
                document.getElementById('txn-tbody').innerHTML = rows;
                
                // Update pagination controls
                updatePaginationControls(filteredData.length, totalPages);
            }
            
            // Reset select all checkbox
            document.getElementById('select-all-checkbox').checked = false;
            updateSelectedCount();
        }
        
        function updatePaginationControls(totalItems, totalPages) {
            const paginationControls = document.getElementById('pagination-controls');
            const paginationInfo = document.getElementById('pagination-info');
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            const pageNumbers = document.getElementById('page-numbers');
            
            if (!paginationControls) return;
            
            if (totalPages <= 1) {
                paginationControls.style.display = 'none';
                return;
            }
            
            paginationControls.style.display = 'flex';
            paginationControls.style.justifyContent = 'space-between';
            paginationControls.style.alignItems = 'center';
            
            // Update info text
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, totalItems);
            paginationInfo.textContent = `Showing ${startIndex}-${endIndex} of ${totalItems}`;
            
            // Update Previous/Next buttons
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            
            if (prevBtn.disabled) {
                prevBtn.style.opacity = '0.5';
                prevBtn.style.cursor = 'not-allowed';
            } else {
                prevBtn.style.opacity = '1';
                prevBtn.style.cursor = 'pointer';
            }
            
            if (nextBtn.disabled) {
                nextBtn.style.opacity = '0.5';
                nextBtn.style.cursor = 'not-allowed';
            } else {
                nextBtn.style.opacity = '1';
                nextBtn.style.cursor = 'pointer';
            }
            
            // Generate page numbers (show max 5 pages)
            pageNumbers.innerHTML = '';
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.style.cssText = `padding: 8px 12px; background: ${i === currentPage ? '#3f3f46' : '#18181b'}; color: #fff; border: 1px solid #27272a; border-radius: 8px; cursor: pointer; font-size: 13px; min-width: 36px; transition: all 0.2s;`;
                if (i === currentPage) {
                    pageBtn.style.borderColor = '#b5ff7d';
                }
                pageBtn.onclick = () => goToPage(i);
                pageBtn.onmouseover = function() {
                    if (i !== currentPage) this.style.background = '#27272a';
                };
                pageBtn.onmouseout = function() {
                    if (i !== currentPage) this.style.background = '#18181b';
                };
                pageNumbers.appendChild(pageBtn);
            }
        }
        
        function goToPage(page) {
            currentPage = page;
            applyFilters(false); // Don't reset page when navigating
            // Scroll to top of table
            const table = document.getElementById('transactions-table');
            if (table) {
                table.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        function goToPreviousPage() {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        }
        
        function goToNextPage() {
            const filteredData = applyFiltersToData(allTransactions);
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        }
        
        function clearFilters() {
            // Clear all filters
            document.getElementById('search-transactions').value = '';
            document.getElementById('filter-type-category').value = '';
            document.getElementById('filter-date-range').value = 'all';
            document.getElementById('custom-date-range').style.display = 'none';
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            
            // Reset to page 1
            currentPage = 1;
            
            // Reapply filters (which will show all transactions)
            applyFilters();
        }

        function handleDateRangeChange() {
            const dateRange = document.getElementById('filter-date-range').value;
            const customDateRange = document.getElementById('custom-date-range');
            
            if (dateRange === 'custom') {
                customDateRange.style.display = 'flex';
            } else {
                customDateRange.style.display = 'none';
                applyFilters();
            }
        }

        function updateCategoryChart(transactions = null) {
            // Use provided transactions or allTransactions, or fetch if needed
            let dataToUse = transactions;
            if (!dataToUse) {
                if (allTransactions && allTransactions.length > 0) {
                    dataToUse = allTransactions;
                } else {
                    // Fetch transactions if not available
                    const currentToken = getToken();
                    if (!currentToken) return;
                    fetch(`${API_BASE_URL}/api/transactions`, {
                        headers: { 'Authorization': 'Bearer ' + currentToken }
                    }).then(res => res.json()).then(data => {
                        renderCategoryChart(data);
                    }).catch(err => console.error('Error:', err));
                    return;
                }
            }
            renderCategoryChart(dataToUse);
        }

        // Chart period state (daily, weekly, monthly, yearly, all)
        let chartPeriod = 'all';

        function updateChartPeriod() {
            const select = document.getElementById('chart-period-select');
            if (select) {
                chartPeriod = select.value;
                // Re-render chart with new period filter
                updateCategoryChart();
            }
        }
        
        function filterTransactionsByPeriod(transactions) {
            if (chartPeriod === 'all') {
                return transactions;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            return transactions.filter(t => {
                const transactionDate = new Date(t.date + 'T00:00:00');
                transactionDate.setHours(0, 0, 0, 0);
                
                switch (chartPeriod) {
                    case 'daily':
                        return transactionDate.getTime() === today.getTime();
                    
                    case 'weekly':
                        const startOfWeek = new Date(today);
                        const day = startOfWeek.getDay();
                        const diff = startOfWeek.getDate() - day; // Get Sunday
                        startOfWeek.setDate(diff);
                        startOfWeek.setHours(0, 0, 0, 0);
                        const endOfWeek = new Date(today);
                        endOfWeek.setHours(23, 59, 59, 999);
                        return transactionDate >= startOfWeek && transactionDate <= endOfWeek;
                    
                    case 'monthly':
                        return transactionDate.getMonth() === today.getMonth() && 
                               transactionDate.getFullYear() === today.getFullYear();
                    
                    case 'yearly':
                        return transactionDate.getFullYear() === today.getFullYear();
                    
                    default:
                        return true;
                }
            });
        }

        function renderCategoryChart(transactions) {
            // Filter to only show expenses (no income)
            const expenseTransactions = transactions.filter(t => t.type === 'EXPENSE');
            
            // Apply time period filter
            const filteredTransactions = filterTransactionsByPeriod(expenseTransactions);
            
            // Calculate by category (only expenses)
            const categoryData = {};
            filteredTransactions.forEach(t => {
                // Handle null categories - income shows "-", expenses show "Uncategorized"
                const category = t.category || (t.type === 'INCOME' ? '-' : 'Uncategorized');
                categoryData[category] = (categoryData[category] || 0) + t.amount;
            });

            const categories = Object.keys(categoryData);
            const amounts = Object.values(categoryData);

            const ctx = document.getElementById('categoryChart');
            const legendContainer = document.getElementById('chart-legend');
            
            if (!ctx) return;

            // Destroy previous chart
            if (categoryChart) {
                categoryChart.destroy();
                categoryChart = null;
            }

            if (categories.length === 0) {
                // Show empty state
                    categoryChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                        labels: ['No expenses yet'],
                            datasets: [{
                                data: [1],
                            backgroundColor: ['#27272a'],
                            borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                        },
                        animation: {
                            animateRotate: true,
                            animateScale: true
                            }
                        }
                    });
                if (legendContainer) legendContainer.innerHTML = '';
                return;
            }

            // Get colors for categories - use actual category colors
            const defaultColors = ['#b5ff7d', '#48c6ef', '#ff5757', '#ffa500', '#9b59b6', '#3498db', '#e74c3c', '#f39c12', '#1abc9c', '#34495e'];
            const backgroundColors = categories.map((cat, i) => {
                // Try to find category by name (case-insensitive)
                const category = allCategories.find(c => 
                    c.name && cat && c.name.toLowerCase() === cat.toLowerCase()
                );
                // Use category colour if found, otherwise use default color
                if (category && category.colour) {
                    return category.colour;
                }
                // Fallback to default colors
                return defaultColors[i % defaultColors.length];
            });

            // No border colors - remove gaps
            const borderColors = backgroundColors.map(() => 'transparent');

            // Always animate smoothly on first render
            const isFirstLoad = !categoryChart;

            // Create chart with all data
                categoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: categories,
                        datasets: [{
                            data: amounts,
                            backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 0, // No gaps between segments
                        spacing: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                    cutout: '65%',
                        plugins: {
                            legend: {
                            display: false // We'll use custom legend
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return context.label + ': ' + formatCurrency(context.parsed) + ' (' + percentage + '%)';
                                    }
                                }
                            }
                        },
                        animation: {
                            animateRotate: true,
                        animateScale: false,
                        duration: isFirstLoad ? 2500 : 500,
                        easing: 'easeOutCubic',
                        delay: isFirstLoad ? 0 : 0
                    },
                    rotation: -90,
                    circumference: 360
                },
                plugins: []
            });

            // Animate segments appearing one by one using requestAnimationFrame
            if (isFirstLoad && categories.length > 0) {
                // Wait for chart to be fully initialized
                setTimeout(() => {
                    const startTime = performance.now();
                    const totalDuration = 2000; // Reduced duration for smoother animation
                    let lastUpdateTime = startTime;
                    const minFrameTime = 16; // ~60fps
                    
                    function animateSegments(currentTime) {
                        if (!categoryChart) return;
                        
                        // Throttle updates for smoother performance
                        if (currentTime - lastUpdateTime < minFrameTime && currentTime - startTime < totalDuration) {
                            requestAnimationFrame(animateSegments);
                            return;
                        }
                        lastUpdateTime = currentTime;
                        
                        const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / totalDuration, 1);
                    
                        // Use easing function for smoother animation
                        const easedProgress = 1 - Math.pow(1 - progress, 3); // Ease out cubic
                        const visibleCount = Math.ceil(easedProgress * categories.length);
                        
                        const meta = categoryChart.getDatasetMeta(0);
                        if (meta && meta.data) {
                            let needsUpdate = false;
                        meta.data.forEach((arc, index) => {
                                const shouldBeVisible = index < visibleCount;
                                if (arc.hidden !== !shouldBeVisible) {
                                    arc.hidden = !shouldBeVisible;
                                    needsUpdate = true;
                                }
                            });
                            
                            if (needsUpdate) {
                        categoryChart.update('none');
                            }
                    }
                    
                    if (progress < 1) {
                        requestAnimationFrame(animateSegments);
                    } else {
                        // Ensure all segments are visible at the end
                        if (categoryChart) {
                            const meta = categoryChart.getDatasetMeta(0);
                                if (meta && meta.data) {
                            meta.data.forEach(arc => arc.hidden = false);
                            categoryChart.update('none');
                                }
                        }
                    }
                }
                
                    // Start animation immediately
                    requestAnimationFrame(animateSegments);
                }, 100);
            }

            // Create custom legend
            if (legendContainer) {
                const total = amounts.reduce((a, b) => a + b, 0);
                legendContainer.innerHTML = categories.map((cat, i) => {
                    const percentage = ((amounts[i] / total) * 100).toFixed(1);
                    // Get full category name from allCategories if available (case-insensitive)
                    const categoryObj = allCategories.find(c => 
                        c.name && cat && c.name.toLowerCase() === cat.toLowerCase()
                    );
                    const displayName = categoryObj ? categoryObj.name : cat;
                    // Use the same color from backgroundColors array to ensure consistency
                    const legendColor = backgroundColors[i];
                    return `
                        <div style="display: flex; align-items: flex-start; margin-bottom: 12px; width: 100%; max-width: 100%; box-sizing: border-box;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${legendColor}; margin-right: 10px; margin-top: 2px; flex-shrink: 0;"></div>
                            <div style="color: #fff; font-size: 12px; flex: 1; min-width: 0; max-width: 100%; overflow: hidden; box-sizing: border-box;">
                                <div style="font-weight: 600; word-wrap: break-word; word-break: break-word; white-space: normal; overflow-wrap: break-word; line-height: 1.4; max-width: 100%;">${displayName}</div>
                                <div style="color: #a1a1aa; font-size: 11px; margin-top: 2px; line-height: 1.3; word-wrap: break-word; overflow-wrap: break-word; max-width: 100%;">${formatCurrency(amounts[i])} (${percentage}%)</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }


        // Store current filter
        let currentExpenseFilter = 'today';
        
        function setExpenseFilter(filter) {
            currentExpenseFilter = filter;
            
            // Update button states
            document.querySelectorAll('.expense-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`filter-${filter}`).classList.add('active');
            
            // Refresh the display
            if (window.allTransactions) {
                updateUpcomingBillsChart(window.allTransactions);
            }
        }
        
        function updateUpcomingBillsChart(transactions) {
            const container = document.getElementById('upcoming-bills-container');
            if (!container) return;

            // Get all recurring transactions
            const recurringTransactions = transactions.filter(t => t.isRecurring === true);
            
            if (recurringTransactions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #a1a1aa; padding: 40px;">No recurring expenses</div>';
                return;
            }

            // Parse dates and filter based on selected period
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let startDate = new Date(today);
            let endDate = new Date(today);
            
            switch (currentExpenseFilter) {
                case 'today':
                    // Today only
                    endDate = new Date(today);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'week':
                    // This week (start of week to end of week)
                    const dayOfWeek = today.getDay();
                    startDate.setDate(today.getDate() - dayOfWeek);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'month':
                    // This month
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59, 999);
                    break;
            }

            // Filter recurring transactions by date within the selected period
            const filteredExpenses = [];
            
            // Note: 'today' is already declared above, so we reuse it here
            // Filter out past dates - only show expenses from today onwards
            recurringTransactions.forEach(t => {
                if (!t.date) return;
                
                // Parse transaction date (YYYY-MM-DD format)
                const transactionDate = new Date(t.date + 'T00:00:00');
                transactionDate.setHours(0, 0, 0, 0);
                
                // Check if transaction date falls within the selected period AND is not in the past
                if (transactionDate >= startDate && transactionDate <= endDate && transactionDate >= today) {
                    filteredExpenses.push({
                        id: t.id,
                        description: t.description || 'Expense',
                        amount: t.amount || 0,
                        category: t.category || 'Uncategorized',
                        date: t.date
                    });
                }
            });

            // Sort by date (soonest first)
            filteredExpenses.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateA - dateB;
            });

            if (filteredExpenses.length === 0) {
                const periodText = currentExpenseFilter === 'today' ? 'today' : 
                                  currentExpenseFilter === 'week' ? 'this week' : 'this month';
                container.innerHTML = `<div style="text-align: center; color: #a1a1aa; padding: 40px;">No recurring expenses ${periodText}</div>`;
                return;
            }

            // Get icon based on category from allCategories
            function getExpenseIcon(category) {
                if (!category) {
                    return { icon: 'fa-circle-question', color: '#52525b' };
                }
                
                // Find category in allCategories array
                const categoryObj = allCategories.find(c => 
                    c.name && category && c.name.toLowerCase() === category.toLowerCase()
                );
                
                if (categoryObj) {
                    return { 
                        icon: categoryObj.icon || 'fa-circle-question', 
                        color: categoryObj.colour || '#52525b' 
                    };
                }
                
                // Default fallback
                return { icon: 'fa-circle-question', color: '#52525b' };
            }

            // Display expenses (show first 4)
            const displayExpenses = filteredExpenses.slice(0, 4);

            let html = '';
            
            // First expense gets featured (wider) card
            if (displayExpenses.length > 0) {
                const firstExpense = displayExpenses[0];
                const iconInfo = getExpenseIcon(firstExpense.category);
                html += `
                    <div class="bill-card featured">
                        <div class="bill-card-icon" style="background: ${iconInfo.color}20; color: ${iconInfo.color};">
                            <i class="fa-solid ${iconInfo.icon}"></i>
                        </div>
                        <div class="bill-card-content">
                            <div class="bill-card-name">${firstExpense.description}</div>
                            <div class="bill-card-due">${firstExpense.date}</div>
                        </div>
                        <div class="bill-card-amount">
                            <div class="bill-card-amount-value">${formatCurrency(firstExpense.amount)}</div>
                        </div>
                    </div>
                `;
            }

            // Remaining expenses in grid
            if (displayExpenses.length > 1) {
                html += '<div class="bills-grid">';
                for (let i = 1; i < displayExpenses.length; i++) {
                    const expense = displayExpenses[i];
                    const iconInfo = getExpenseIcon(expense.category);
                    html += `
                        <div class="bill-card">
                            <div class="bill-card-icon" style="background: ${iconInfo.color}20; color: ${iconInfo.color};">
                                <i class="fa-solid ${iconInfo.icon}"></i>
                            </div>
                            <div class="bill-card-content">
                                <div class="bill-card-name">${expense.description}</div>
                                <div class="bill-card-due">${expense.date}</div>
                            </div>
                            <div class="bill-card-amount">
                                <div class="bill-card-amount-value">${formatCurrency(expense.amount)}</div>
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
            }

            container.innerHTML = html;
        }

        async function loadUserInfo() {
            try {
                const currentToken = getToken();
                if (!currentToken) {
                    console.error('No token available for user info request');
                    console.error('localStorage contents:', JSON.stringify({...localStorage}));
                    showAlertDialog('Authentication token missing. Please log in again.', 'Authentication Error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return;
                }
                
                console.log('=== LOAD USER INFO DEBUG ===');
                console.log('Fetching user info from:', `${API_BASE_URL}/api/user`);
                console.log('Token present:', !!currentToken);
                console.log('Token length:', currentToken.length);
                console.log('Token preview:', currentToken.substring(0, 30) + '...');
                console.log('Full token (for debugging):', currentToken);
                
                const headers = { 
                    'Authorization': 'Bearer ' + currentToken,
                    'Content-Type': 'application/json'
                };
                console.log('Request headers:', headers);
                
                const res = await fetch(`${API_BASE_URL}/api/user`, {
                    method: 'GET',
                    headers: headers,
                    mode: 'cors',
                    credentials: 'include'
                });
                
                console.log('User info response status:', res.status, res.statusText);
                console.log('Response Content-Type:', res.headers.get('Content-Type'));
                
                if (res.status === 401 || res.status === 403) {
                    console.error('Authentication failed for user info:', res.status);
                    showAlertDialog('Authentication failed. Please log in again.', 'Error');
                    setTimeout(() => {
                        localStorage.removeItem('jwtToken');
                        window.location.href = 'index.html';
                    }, 2000);
                    const displayName = 'User';
                    document.getElementById('greeting-text').textContent = `Hi, ${displayName}`;
                    document.getElementById('user-initial').textContent = 'U';
                    return;
                }
                
                if (res.ok) {
                    const user = await res.json();
                    console.log('User data received:', user);
                    const displayName = user.username || user.email.split('@')[0];
                    const userInitial = displayName.charAt(0).toUpperCase();
                    document.getElementById('user-initial').textContent = userInitial;
                    
                    // Update account section
                    const accountInitial = document.getElementById('account-initial');
                    const accountUsername = document.getElementById('account-username');
                    const accountEmail = document.getElementById('account-email');
                    const accountInitialDisplay = document.getElementById('account-initial-display');
                    const accountUsernameDisplay = document.getElementById('account-username-display');
                    const accountEmailDisplay = document.getElementById('account-email-display');
                    const passwordSection = document.getElementById('password-section');
                    const profileSection = document.getElementById('profile-section');
                    const profileDisplay = document.getElementById('profile-display');
                    
                    const usernameText = user.username || displayName;
                    
                    // Update profile section (for local accounts with edit button)
                    if (accountInitial) accountInitial.textContent = userInitial;
                    if (accountUsername) accountUsername.textContent = usernameText;
                    if (accountEmail) accountEmail.textContent = user.email;
                    
                    // Update display section (for non-local accounts)
                    if (accountInitialDisplay) accountInitialDisplay.textContent = userInitial;
                    if (accountUsernameDisplay) accountUsernameDisplay.textContent = usernameText;
                    if (accountEmailDisplay) accountEmailDisplay.textContent = user.email;
                    
                    // Populate profile input fields
                    const profileUsernameInput = document.getElementById('profile-username');
                    const profileEmailInput = document.getElementById('profile-email');
                    if (profileUsernameInput) profileUsernameInput.value = usernameText;
                    if (profileEmailInput) profileEmailInput.value = user.email;
                    
                    // Show password and profile sections (all accounts are local)
                    if (passwordSection) passwordSection.style.display = 'block';
                    if (profileSection) profileSection.style.display = 'block';
                    if (profileDisplay) profileDisplay.style.display = 'none';
                    
                    // Time-based greeting
                    const hour = new Date().getHours();
                    let greeting = 'Good Morning';
                    if (hour >= 12 && hour < 17) greeting = 'Good Afternoon';
                    else if (hour >= 17) greeting = 'Good Evening';
                    
                    document.getElementById('greeting-text').textContent = `${greeting}, ${displayName}`;
                    
                    // Load user currency setting
                    if (user.currency) {
                        userCurrency = user.currency;
                    } else {
                        // Default to MYR if not set
                        userCurrency = 'MYR';
                    }
                    const currencySelect = document.getElementById('currency-select');
                    if (currencySelect) {
                        currencySelect.value = userCurrency;
                    }
                    
                    // Refresh all currency displays
                    refreshCurrencyDisplays();
                } else {
                    // Handle other error statuses
                    let errorText = '';
                    let errorData = null;
                    try {
                        const contentType = res.headers.get('Content-Type');
                        if (contentType && contentType.includes('application/json')) {
                            errorData = await res.json();
                            errorText = errorData.error || errorData.message || 'Unknown error';
                        } else {
                            errorText = await res.text().catch(() => 'Unknown error');
                        }
                    } catch (e) {
                        console.error('Error parsing error response:', e);
                        errorText = 'Failed to parse error response';
                    }
                    
                    console.error('=== USER INFO FETCH FAILED ===');
                    console.error('Status:', res.status, res.statusText);
                    console.error('Error data:', errorData);
                    console.error('Error text:', errorText);
                    
                    if (res.status === 401 || res.status === 403) {
                        showAlertDialog('Authentication failed. Please log in again.', 'Authentication Error');
                        setTimeout(() => {
                            localStorage.removeItem('jwtToken');
                            window.location.href = 'index.html';
                        }, 2000);
                    } else if (res.status === 404) {
                        showAlertDialog('User account not found. Please log in again.', 'Account Error');
                        setTimeout(() => {
                            localStorage.removeItem('jwtToken');
                            window.location.href = 'index.html';
                        }, 2000);
                    } else {
                        showAlertDialog(`Failed to load user information (${res.status}): ${errorText}`, 'Error');
                    }
                    
                    const displayName = 'User';
                    document.getElementById('greeting-text').textContent = `Hi, ${displayName}`;
                    document.getElementById('user-initial').textContent = 'U';
                }
            } catch (e) {
                console.error('=== EXCEPTION IN loadUserInfo ===');
                console.error('Error type:', e.name);
                console.error('Error message:', e.message);
                console.error('Error stack:', e.stack);
                
                let errorMessage = 'Failed to load user information. ';
                if (e.name === 'TypeError' && e.message.includes('Failed to fetch')) {
                    errorMessage += `Cannot connect to server at ${API_BASE_URL}. `;
                    errorMessage += 'Please ensure the Spring Boot server is running.';
                } else if (e.message) {
                    errorMessage += e.message;
                }
                
                if (errorMessage.includes('Cannot connect')) {
                    showAlertDialog(errorMessage, 'Connection Error');
                } else {
                    showAlertDialog('Failed to load user information. Please check the console for details.', 'Error');
                }
                
                const displayName = 'User';
                document.getElementById('greeting-text').textContent = `Hi, ${displayName}`;
                document.getElementById('user-initial').textContent = 'U';
            }
        }
        
        function togglePasswordVisibility(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
        
        function toggleEditProfile() {
            const editForm = document.getElementById('edit-profile-form');
            if (editForm) {
                editForm.style.display = editForm.style.display === 'none' ? 'block' : 'none';
            }
        }

        function cancelEditProfile() {
            const editForm = document.getElementById('edit-profile-form');
            if (editForm) {
                editForm.style.display = 'none';
            }
            // Reset input fields to current values
            const accountUsername = document.getElementById('account-username');
            const accountEmail = document.getElementById('account-email');
            const profileUsernameInput = document.getElementById('profile-username');
            const profileEmailInput = document.getElementById('profile-email');
            
            if (profileUsernameInput && accountUsername) {
                profileUsernameInput.value = accountUsername.textContent;
            }
            if (profileEmailInput && accountEmail) {
                profileEmailInput.value = accountEmail.textContent;
            }
        }

        async function updateProfile() {
            const username = document.getElementById('profile-username').value.trim();
            const email = document.getElementById('profile-email').value.trim();
            
            if (!username && !email) {
                showAlertDialog('Please enter a name or email to update.', 'Validation Error');
                return;
            }
            
            if (email && !email.includes('@')) {
                showAlertDialog('Please enter a valid email address.', 'Validation Error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/user/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getToken()
                    },
                    body: JSON.stringify({
                        username: username || null,
                        email: email || null
                    })
                });
                
                if (res.status === 403) {
                    showConfirmDialog('Session expired. Log in again?', 'Session Expired', (result) => {
                        if (result) {
                            localStorage.removeItem('jwtToken');
                            window.location.href = 'index.html';
                        }
                    });
                    return;
                }
                
                if (res.ok) {
                    const updatedUser = await res.json();
                    showAlertDialog('Profile updated successfully!', 'Success');
                    
                    // Update displayed values
                    const accountUsername = document.getElementById('account-username');
                    const accountEmail = document.getElementById('account-email');
                    const accountInitial = document.getElementById('account-initial');
                    const accountUsernameDisplay = document.getElementById('account-username-display');
                    const accountEmailDisplay = document.getElementById('account-email-display');
                    const accountInitialDisplay = document.getElementById('account-initial-display');
                    
                    const displayName = updatedUser.username || updatedUser.email.split('@')[0];
                    const userInitial = displayName.charAt(0).toUpperCase();
                    
                    if (updatedUser.username) {
                        if (accountUsername) accountUsername.textContent = updatedUser.username;
                        if (accountUsernameDisplay) accountUsernameDisplay.textContent = updatedUser.username;
                        if (accountInitial) accountInitial.textContent = userInitial;
                        if (accountInitialDisplay) accountInitialDisplay.textContent = userInitial;
                    }
                    
                    if (updatedUser.email) {
                        if (accountEmail) accountEmail.textContent = updatedUser.email;
                        if (accountEmailDisplay) accountEmailDisplay.textContent = updatedUser.email;
                    }
                    
                    // Update greeting if username changed
                    const greetingText = document.getElementById('greeting-text');
                    if (greetingText) {
                        greetingText.textContent = `Hi, ${displayName}`;
                    }
                    const userInitialElement = document.getElementById('user-initial');
                    if (userInitialElement) {
                        userInitialElement.textContent = userInitial;
                    }
                    
                    // Hide edit form after successful update
                    const editForm = document.getElementById('edit-profile-form');
                    if (editForm) {
                        editForm.style.display = 'none';
                    }
                } else {
                    const error = await res.json();
                    showAlertDialog(error.error || 'Failed to update profile.', 'Error');
                }
            } catch (error) {
                showAlertDialog('Error: ' + error.message, 'Error');
            }
        }

        async function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            // First, validate that current password is provided
            if (!currentPassword) {
                showAlertDialog('Please enter your current password', 'Warning');
                document.getElementById('current-password').focus();
                return;
            }
            
            // Get user email from the account section
            const accountEmailElement = document.getElementById('account-email');
            const userEmail = accountEmailElement ? accountEmailElement.textContent.trim() : '';
            
            if (!userEmail) {
                showAlertDialog('Unable to verify password. Please refresh the page.', 'Error');
                return;
            }
            
            // Validate current password first before checking new password fields
            try {
                // Verify current password by attempting to authenticate
                const verifyRes = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: userEmail,
                        password: currentPassword
                    })
                });
                
                if (!verifyRes.ok) {
                    // Current password is wrong
                    showAlertDialog('Wrong password. Please check your current password and try again.', 'Warning');
                    document.getElementById('current-password').style.borderColor = '#ff5757';
                    document.getElementById('current-password').focus();
                    // Clear new password fields
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                    return;
                }
                
                // Current password is correct, reset border color
                document.getElementById('current-password').style.borderColor = 'transparent';
                
            } catch (error) {
                showAlertDialog('Error verifying current password: ' + error.message, 'Error');
                return;
            }
            
            // Now validate new password fields
            if (!newPassword || !confirmPassword) {
                showAlertDialog('Please fill in new password and confirm password', 'Error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showAlertDialog('New passwords do not match', 'Error');
                return;
            }
            
            if (newPassword.length < 6) {
                showAlertDialog('Password must be at least 6 characters long', 'Error');
                return;
            }
            
            // All validations passed, proceed with password update
            try {
                const res = await fetch(`${API_BASE_URL}/api/user/password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getToken()
                    },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                
                if (res.ok) {
                    showAlertDialog('Password updated successfully!', 'Success');
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                    // Reset border color
                    document.getElementById('current-password').style.borderColor = 'transparent';
                } else {
                    const error = await res.json();
                    showAlertDialog(error.error || error.message || 'Failed to update password', 'Error');
                }
            } catch (error) {
                showAlertDialog('Error: ' + error.message, 'Error');
            }
        }
        
        function confirmDeleteAccount() {
            showConfirmDialog(
                'Are you sure you want to delete your account? This action cannot be undone and will permanently delete all your transactions, budgets, and categories.',
                'Delete Account',
                async () => {
                    try {
                        const res = await fetch(`${API_BASE_URL}/api/user`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': 'Bearer ' + getToken()
                            }
                        });
                        
                        if (res.ok) {
                            showAlertDialog('Account deleted successfully. You will be logged out.', 'Account Deleted');
                            setTimeout(() => {
                                logout();
                            }, 2000);
                        } else {
                            const error = await res.json();
                            showAlertDialog(error.message || 'Failed to delete account', 'Error');
                        }
                    } catch (error) {
                        showAlertDialog('Error: ' + error.message, 'Error');
                    }
                }
            );
        }
        
        async function updateCurrency() {
            const currencySelect = document.getElementById('currency-select');
            const newCurrency = currencySelect.value;
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/user/currency`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getToken() 
                    },
                    body: JSON.stringify({ currency: newCurrency })
                });
                
                if (res.ok) {
                    userCurrency = newCurrency;
                    refreshCurrencyDisplays();
                    showAlertDialog('Currency updated successfully!', 'Success');
                } else {
                    showAlertDialog('Failed to update currency', 'Error');
                }
            } catch (error) {
                showAlertDialog('Error: ' + error.message, 'Error');
            }
        }
        
        
        function refreshCurrencyDisplays() {
            // Refresh dashboard amounts
            refreshData();
            // Refresh budgets
            if (document.getElementById('budget').classList.contains('active')) {
                loadBudgets();
            }
        }

        function showUserMenu() {
            confirmLogout();
        }

        async function loadCategories() {
            try {
                const currentToken = getToken();
                if (!currentToken) {
                    console.error('No token available for categories request');
                    return;
                }
                
                console.log('Fetching categories...');
                const res = await fetch(`${API_BASE_URL}/api/categories`, {
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });
                if (!res.ok) {
                    console.error('Failed to load categories:', res.status);
                    return;
                }
                allCategories = await res.json();
                // Sort categories alphabetically by name
                allCategories.sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }));
                populateCategoryButtons();
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function populateCategoryButtons() {
            const select = document.getElementById('category-select');
            if (!allCategories.length) {
                select.innerHTML = '<option value="">No categories available</option>';
                return;
            }
            
            // Sort categories alphabetically by name (case-insensitive)
            const sortedCategories = [...allCategories].sort((a, b) => 
                a.name.localeCompare(b.name, undefined, { sensitivity: 'base' })
            );
            
            // Clear existing options
            select.innerHTML = '<option value="">Select a category</option>';
            
            // Add category options in alphabetical order
            sortedCategories.forEach(c => {
                const option = document.createElement('option');
                option.value = c.name;
                // Use icon name as prefix for visual reference
                const iconName = c.icon ? c.icon.replace('fa-', '') : 'circle-question';
                option.textContent = `${c.name}`;
                option.setAttribute('data-icon', c.icon || 'fa-circle-question');
                select.appendChild(option);
            });
            
            // Populate category filter dropdown
            const categoryFilterGroup = document.getElementById('category-filter-group');
            if (categoryFilterGroup) {
                categoryFilterGroup.innerHTML = '';
                sortedCategories.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.name;
                    option.textContent = c.name;
                    categoryFilterGroup.appendChild(option);
                });
            }
            
            // Load categories in settings view if on settings page
            if (document.getElementById('settings').classList.contains('active')) {
                loadCategoriesList();
            }
            
            // Ensure change handler is attached
            if (!select.hasAttribute('data-handler-attached')) {
                select.addEventListener('change', selectCategory);
                select.setAttribute('data-handler-attached', 'true');
            }
            
            // Load categories in settings view if on settings page
            if (document.getElementById('settings').classList.contains('active')) {
                loadCategoriesList();
            }
        }
        
        // Category Management Functions
        let editingCategoryId = null;
        const commonIcons = [
            'fa-utensils', 'fa-home', 'fa-car', 'fa-shopping-cart', 'fa-gamepad', 'fa-heart-pulse',
            'fa-graduation-cap', 'fa-plane', 'fa-gift', 'fa-dumbbell', 'fa-music', 'fa-film',
            'fa-book', 'fa-laptop', 'fa-mobile-screen', 'fa-shirt', 'fa-briefcase', 'fa-wallet',
            'fa-coffee', 'fa-pizza-slice', 'fa-hamburger', 'fa-ice-cream', 'fa-birthday-cake', 'fa-wine-glass',
            'fa-gas-pump', 'fa-wrench', 'fa-tools', 'fa-paintbrush', 'fa-hammer', 'fa-lightbulb',
            'fa-tv', 'fa-wifi', 'fa-phone', 'fa-envelope', 'fa-calendar', 'fa-clock',
            'fa-money-bill', 'fa-credit-card', 'fa-piggy-bank', 'fa-chart-line', 'fa-tags', 'fa-star'
        ];
        
        async function loadCategoriesList() {
            try {
                const currentToken = getToken();
                if (!currentToken) {
                    console.error('No token available for categories list request');
                    return;
                }
                
                const res = await fetch(`${API_BASE_URL}/api/categories`, {
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });
                if (!res.ok) {
                    console.error('Failed to load categories list:', res.status);
                    const errorText = await res.text();
                    console.error('Error response:', errorText);
                    if (res.status === 401 || res.status === 403) {
                        showAlertDialog('Authentication failed. Please log in again.', 'Error');
                    }
                    return;
                }
                
                const categories = await res.json();
                const categoriesList = document.getElementById('categories-list');
                
                if (!categoriesList) return; // Settings view not loaded yet
                
                if (categories.length === 0) {
                    categoriesList.innerHTML = '<p style="color: #a1a1aa; text-align: center; grid-column: 1 / -1;">No categories yet. Click "Add Category" to create one.</p>';
                    return;
                }
                
                // Separate system and user categories for display
                const systemCategories = categories.filter(cat => cat.isSystem === true);
                const userCategories = categories.filter(cat => !cat.isSystem || cat.isSystem === false);
                
                // Sort both arrays alphabetically by name
                systemCategories.sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }));
                userCategories.sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }));
                
                let html = '';
                
                // Render system categories first (read-only)
                if (systemCategories.length > 0) {
                    html += systemCategories.map(cat => `
                        <div class="category-card" style="opacity: 0.9; border-color: #1a1a1a;">
                            <div class="category-card-icon" style="background: ${cat.colour || '#52525b'}; color: #fff;">
                                <i class="fa-solid ${cat.icon || 'fa-circle-question'}"></i>
                            </div>
                            <div class="category-card-info">
                                <div class="category-card-name">${cat.name}</div>
                            </div>
                        </div>
                    `).join('');
                }
                
                // Render user categories (editable)
                if (userCategories.length > 0) {
                    html += userCategories.map(cat => `
                        <div class="category-card">
                            <div class="category-card-icon" style="background: ${cat.colour || '#52525b'}; color: #fff;">
                                <i class="fa-solid ${cat.icon || 'fa-circle-question'}"></i>
                            </div>
                            <div class="category-card-info">
                                <div class="category-card-name">${cat.name}</div>
                            </div>
                            <div class="category-card-actions">
                                <button class="category-card-btn" onclick="editCategory(${cat.id})" title="Edit">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button class="category-card-btn" onclick="deleteCategory(${cat.id})" title="Delete" style="color: #ff5757;">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
                
                categoriesList.innerHTML = html;
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        
        function openCategoryModal(categoryId = null) {
            editingCategoryId = categoryId;
            
            // Setup color picker sync
            setupColorPickerSync();
            
            if (categoryId) {
                document.getElementById('category-modal-title').textContent = 'Edit Category';
                document.getElementById('category-save-btn').textContent = 'Update Category';
                
                // Load category data
                fetch(`${API_BASE_URL}/api/categories/${categoryId}`, {
                    headers: { 'Authorization': 'Bearer ' + getToken() }
                })
                    .then(res => res.json())
                    .then(category => {
                        document.getElementById('category-name-input').value = category.name;
                        document.getElementById('category-icon-input').value = category.icon || 'fa-circle-question';
                        document.getElementById('category-color-input').value = category.colour || '#52525b';
                        document.getElementById('category-color-hex').value = category.colour || '#52525b';
                        
                        // Select the icon
                        populateIconGrid();
                        selectIcon(category.icon || 'fa-circle-question');
                    })
                    .catch(error => {
                        showAlertDialog('Error loading category: ' + error.message, 'Error');
                    });
            } else {
                document.getElementById('category-modal-title').textContent = 'Add Category';
                document.getElementById('category-save-btn').textContent = 'Add Category';
                
                // Reset form
                document.getElementById('category-name-input').value = '';
                document.getElementById('category-icon-input').value = 'fa-circle-question';
                document.getElementById('category-color-input').value = '#52525b';
                document.getElementById('category-color-hex').value = '#52525b';
                
                populateIconGrid();
                selectIcon('fa-circle-question');
            }
            
            document.getElementById('modal-backdrop').style.display = 'block';
            document.getElementById('categoryModal').style.display = 'flex';
        }
        
        function closeCategoryModal() {
            document.getElementById('modal-backdrop').style.display = 'none';
            document.getElementById('categoryModal').style.display = 'none';
            editingCategoryId = null;
        }
        
        function populateIconGrid() {
            const iconGrid = document.querySelector('#categoryModal .input-group:nth-of-type(2) div');
            if (!iconGrid) return;
            iconGrid.innerHTML = commonIcons.map(icon => `
                <div class="icon-option" onclick="selectIcon('${icon}')" data-icon="${icon}">
                    <i class="fa-solid ${icon}"></i>
                </div>
            `).join('');
        }
        
        function selectIcon(iconName) {
            // Update hidden input
            const iconInput = document.getElementById('category-icon-input');
            if (iconInput) {
                iconInput.value = iconName;
            }
            
            // Update visual selection
            document.querySelectorAll('.icon-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.icon === iconName) {
                    opt.classList.add('selected');
                }
            });
        }
        
        // Sync color picker with hex input
        function setupColorPickerSync() {
            const colorInput = document.getElementById('category-color-input');
            const hexInput = document.getElementById('category-color-hex');
            
            if (colorInput && hexInput) {
                // Remove existing listeners by cloning
                const newColorInput = colorInput.cloneNode(true);
                const newHexInput = hexInput.cloneNode(true);
                colorInput.parentNode.replaceChild(newColorInput, colorInput);
                hexInput.parentNode.replaceChild(newHexInput, hexInput);
                
                // Re-get elements
                const color = document.getElementById('category-color-input');
                const hex = document.getElementById('category-color-hex');
                
                color.addEventListener('input', (e) => {
                    hex.value = e.target.value.toUpperCase();
                });
                
                hex.addEventListener('input', (e) => {
                    const hexVal = e.target.value.replace('#', '');
                    if (/^[0-9A-F]{6}$/i.test(hexVal)) {
                        color.value = '#' + hexVal;
                    }
                });
            }
        }
        
        async function saveCategory() {
            const nameInput = document.getElementById('category-name-input');
            const iconInput = document.getElementById('category-icon-input');
            const colorInput = document.getElementById('category-color-input');
            
            if (!nameInput || !iconInput || !colorInput) return;
            
            const name = nameInput.value.trim();
            const icon = iconInput.value;
            const color = colorInput.value;
            
            if (!name) {
                showAlertDialog('Please enter a category name', 'Validation Error');
                return;
            }
            
            const categoryData = {
                name: name,
                icon: icon,
                colour: color
            };
            
            const btn = document.getElementById('category-save-btn');
            btn.disabled = true;
            btn.textContent = editingCategoryId ? 'Updating...' : 'Creating...';
            
            try {
                const url = editingCategoryId 
                    ? `${API_BASE_URL}/api/categories/${editingCategoryId}`
                    : `${API_BASE_URL}/api/categories`;
                const method = editingCategoryId ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getToken()
                    },
                    body: JSON.stringify(categoryData)
                });
                
                if (res.ok) {
                    closeCategoryModal();
                    await loadCategories(); // Reload categories for dropdowns
                    loadCategoriesList(); // Reload categories in settings view
                    showAlertDialog(editingCategoryId ? 'Category updated successfully!' : 'Category created successfully!', 'Success');
                } else {
                    const errorText = await res.text();
                    showAlertDialog('Error: ' + errorText, 'Error');
                }
            } catch (error) {
                showAlertDialog('Error: ' + error.message, 'Error');
            } finally {
                btn.disabled = false;
                btn.textContent = editingCategoryId ? 'Update Category' : 'Add Category';
            }
        }
        
        function editCategory(id) {
            openCategoryModal(id);
        }
        
        async function deleteCategory(id) {
            // Get category name for confirmation
            try {
                const res = await fetch(`${API_BASE_URL}/api/categories/${id}`, {
                    headers: { 'Authorization': 'Bearer ' + getToken() }
                });
                if (!res.ok) {
                    showAlertDialog('Category not found', 'Error');
                    return;
                }
                
                const category = await res.json();
                showConfirmDialog(`Are you sure you want to delete the category "${category.name}"? This action cannot be undone.`, 'Delete Category', async (result) => {
                    if (!result) return;
                    
                    try {
                        const deleteRes = await fetch(`${API_BASE_URL}/api/categories/${id}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': 'Bearer ' + getToken() }
                        });
                        
                        if (deleteRes.ok) {
                            await loadCategories(); // Reload categories for dropdowns
                            loadCategoriesList(); // Reload categories in settings view
                            showAlertDialog('Category deleted successfully!', 'Success');
                        } else {
                            const errorText = await deleteRes.text();
                            showAlertDialog('Error: ' + errorText, 'Error');
                        }
                    } catch (error) {
                        showAlertDialog('Error: ' + error.message, 'Error');
                    }
                });
            } catch (error) {
                showAlertDialog('Error: ' + error.message, 'Error');
            }
        }

        function openModal() {
            // Reset edit state
            editingTransactionId = null;
            existingAttachmentUrls = null;
            keptExistingAttachments = [];
            document.querySelector('#txnModal .modal-header h2').textContent = 'Add Transaction';
            document.querySelector('#txnModal .save-btn').textContent = 'Add Transaction';
            
            selectedCategory = '';
            currentModalType = 'EXPENSE';
            selectedFiles = [];
            keptExistingAttachments = [];
            isRecurring = false;
            
            // Reset form fields
            document.getElementById('amount-input').value = '';
            document.getElementById('desc').value = '';
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('category-select').value = '';
            const toggleBtn = document.getElementById('recurring-toggle-btn');
            const options = document.getElementById('recurring-options');
            if (toggleBtn) {
                toggleBtn.classList.remove('active');
            }
            if (options) {
                options.classList.remove('active');
                options.style.display = ''; // Remove inline style to let CSS handle it
            }
            document.getElementById('recurring-frequency').value = 'DAILY';
            document.getElementById('recurring-end-date').value = '';
            // Clear file preview
            renderAttachmentPreview();
            
            // Reset tabs - default to EXPENSE
            currentModalType = 'EXPENSE';
            document.getElementById('tab-expense').classList.add('active');
            document.getElementById('tab-income').classList.remove('active');
            
            // Reset category visibility (show for expense by default)
            const categoryGroup = document.getElementById('category-group');
            const amountCategoryRow = document.getElementById('amount-category-row');
            if (categoryGroup) {
                categoryGroup.classList.remove('hidden');
                categoryGroup.style.display = 'block'; // Force show
            }
            if (amountCategoryRow) {
                amountCategoryRow.classList.remove('amount-only');
            }
            
            updateAttachmentText();
            renderAttachmentPreview();
            
            document.getElementById('modal-backdrop').style.display = 'block';
            document.getElementById('txnModal').style.display = 'flex';
            
            if (allCategories.length > 0) populateCategoryButtons();
            else loadCategories();
        }

        function closeModal() {
            document.getElementById('modal-backdrop').style.display = 'none';
            document.getElementById('txnModal').style.display = 'none';
            
            // Reset edit state
            editingTransactionId = null;
            existingAttachmentUrls = null;
            keptExistingAttachments = [];
            document.querySelector('#txnModal .modal-header h2').textContent = 'Add Transaction';
            document.querySelector('#txnModal .save-btn').textContent = 'Add Transaction';
            
            // Clear form
            document.getElementById('amount-input').value = '';
            document.getElementById('desc').value = '';
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            selectedCategory = null;
            isRecurring = false;
            const toggleBtn = document.getElementById('recurring-toggle-btn');
            const options = document.getElementById('recurring-options');
            if (toggleBtn) {
                toggleBtn.classList.remove('active');
            }
            if (options) {
                options.classList.remove('active');
                options.style.display = ''; // Remove inline style to let CSS handle it
            }
            
            // Reset recurring form fields
            document.getElementById('recurring-frequency').value = 'DAILY';
            document.getElementById('recurring-end-date').value = '';
            // Clear file input
            const fileInput = document.getElementById('file-input');
            if (fileInput) {
                fileInput.value = '';
            }
            
            // Clear preview
            const preview = document.getElementById('attachment-preview');
            if (preview) {
                preview.innerHTML = '';
            }
        }

        // Close on backdrop click
        document.getElementById('modal-backdrop').addEventListener('click', (e) => {
            if (e.target.id === 'modal-backdrop') {
                // Check which modal is open and close it
                if (document.getElementById('txnModal').style.display === 'flex') {
                    closeModal();
                } else if (document.getElementById('budgetModal').style.display === 'flex') {
                    closeBudgetModal();
                } else if (document.getElementById('budgetDetailModal').style.display === 'flex') {
                    closeBudgetDetailModal();
                } else if (document.getElementById('categoryModal').style.display === 'flex') {
                    closeCategoryModal();
                }
            }
        });

        async function uploadFiles() {
            if (selectedFiles.length === 0) return [];
            
            const uploadedUrls = [];
            
            for (const file of selectedFiles) {
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const res = await fetch(`${API_BASE_URL}/api/files/upload`, {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + getToken() },
                        body: formData
                    });
                    
                    if (res.ok) {
                        const data = await res.json();
                        uploadedUrls.push(data.url);
                    } else {
                        console.error('Failed to upload:', file.name);
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                }
            }
            
            return uploadedUrls;
        }

        async function submitTransaction() {
            const amountInput = document.getElementById('amount-input');
            const amount = parseFloat(amountInput.value);
            const description = document.getElementById('desc').value;
            const date = document.getElementById('date').value;

            // Category is only required for expenses, not income
            if (currentModalType === 'EXPENSE' && !selectedCategory) {
                showAlertDialog('Please select a category', 'Validation Error');
                return;
            }
            if (!amount || amount <= 0) {
                showAlertDialog('Please enter a valid amount', 'Validation Error');
                return;
            }
            
            // Validate recurring end date if recurring is enabled
            if (isRecurring) {
                const endDate = document.getElementById('recurring-end-date').value;
                if (!endDate) {
                    showAlertDialog('Please select an end date for the recurring transaction', 'Validation Error');
                    return;
                }
                // Validate that end date is after start date
                const startDate = new Date(date);
                const endDateObj = new Date(endDate);
                if (endDateObj <= startDate) {
                    showAlertDialog('End date must be after the start date', 'Validation Error');
                    return;
                }
            }

            const btn = document.querySelector('#txnModal .save-btn');
            btn.disabled = true;
            btn.textContent = 'Uploading...';

            try {
                // Upload files first
                const uploadedUrls = await uploadFiles();
                
                btn.textContent = 'Saving...';
                
                // Combine kept existing attachments with new ones (if editing)
                let finalAttachmentUrls = uploadedUrls;
                if (editingTransactionId) {
                    // Combine kept existing attachments with newly uploaded files
                    finalAttachmentUrls = [...keptExistingAttachments, ...uploadedUrls];
                }
                
                const payload = {
                    amount: amount,
                    description: description || (currentModalType === 'EXPENSE' ? 'Expense' : 'Income'),
                    category: currentModalType === 'INCOME' ? null : selectedCategory, // Income doesn't need category
                    date: date,
                    type: currentModalType,
                    receiptImage: finalAttachmentUrls.length > 0 ? finalAttachmentUrls.join(',') : null
                };

                // Add recurring data if enabled
                if (isRecurring) {
                    const endDate = document.getElementById('recurring-end-date').value;
                    payload.recurring = {
                        frequency: document.getElementById('recurring-frequency').value,
                        endDate: endDate // End date is now mandatory, so no need for || null
                    };
                }

                const url = editingTransactionId 
                    ? `${API_BASE_URL}/api/transactions/${editingTransactionId}`
                    : `${API_BASE_URL}/api/transactions`;
                const method = editingTransactionId ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': 'Bearer ' + getToken() 
                    },
                    body: JSON.stringify(payload)
                });

                if (res.status === 403) {
                    showConfirmDialog('Session expired. Log in again?', 'Session Expired', (result) => {
                        if (result) {
                            localStorage.removeItem('jwtToken');
                            window.location.href = 'index.html';
                        }
                    });
                    return;
                }

                if (res.ok) {
                    // Backend handles recurring transaction creation (only for new transactions)
                    closeModal();
                    await refreshData();
                } else {
                    showAlertDialog('Failed to save transaction.', 'Error');
                }
            } catch (error) {
                showAlertDialog('Error: ' + error.message, 'Error');
            } finally {
                btn.disabled = false;
                const txnModalBtn = document.querySelector('#txnModal .save-btn');
                if (txnModalBtn) {
                    txnModalBtn.textContent = 'Add Transaction';
                }
                editingTransactionId = null;
                existingAttachmentUrls = null;
                keptExistingAttachments = [];
            }
        }

        // Edit Transaction
        let editingTransactionId = null;
        let existingAttachmentUrls = null; // Store existing attachments when editing
        let keptExistingAttachments = []; // Track which existing attachments are kept (not removed)
        
        async function editTransaction(id) {
            editingTransactionId = id;
            try {
                const res = await fetch(`${API_BASE_URL}/api/transactions/${id}`, {
                    headers: { 'Authorization': 'Bearer ' + getToken() }
                });
                
                if (!res.ok) {
                    showAlertDialog('Failed to load transaction.', 'Error');
                    return;
                }
                
                const transaction = await res.json();
                
                // Populate modal with transaction data
                document.getElementById('amount-input').value = transaction.amount;
                document.getElementById('desc').value = transaction.description || '';
                document.getElementById('date').value = transaction.date;
                selectedCategory = transaction.category || '';
                
                // Update category dropdown (only if category exists)
                const categorySelect = document.getElementById('category-select');
                if (categorySelect) {
                    categorySelect.value = transaction.category || '';
                }
                
                // Set transaction type (this will hide/show category field appropriately)
                setTxnType(transaction.type);
                
                // Store existing attachments
                existingAttachmentUrls = transaction.receiptImage || null;
                if (existingAttachmentUrls) {
                    // Split by comma and filter empty strings
                    keptExistingAttachments = existingAttachmentUrls.split(',').filter(url => url.trim());
                } else {
                    keptExistingAttachments = [];
                }
                selectedFiles = []; // Clear new file selections
                
                // Render existing attachments in preview
                renderAttachmentPreview();
                
                // Handle recurring fields if applicable
                if (transaction.isRecurring) {
                    isRecurring = true;
                    const toggleBtn = document.getElementById('recurring-toggle-btn');
                    const options = document.getElementById('recurring-options');
                    if (toggleBtn) {
                        toggleBtn.classList.add('active');
                    }
                    if (options) {
                        options.style.display = ''; // Clear inline style, let CSS handle it
                        options.classList.add('active');
                    }
                    document.getElementById('recurring-frequency').value = transaction.recurringFrequency || 'MONTHLY';
                    if (transaction.recurringEndDate) {
                        document.getElementById('recurring-end-date').value = transaction.recurringEndDate;
                    }
                } else {
                    isRecurring = false;
                    const toggleBtn = document.getElementById('recurring-toggle-btn');
                    const options = document.getElementById('recurring-options');
                    if (toggleBtn) {
                        toggleBtn.classList.remove('active');
                    }
                    if (options) {
                        options.style.display = ''; // Clear inline style, let CSS handle it
                        options.classList.remove('active');
                    }
                }
                
                // Update modal title
                document.querySelector('#txnModal .modal-header h2').textContent = 'Edit Transaction';
                document.querySelector('#txnModal .save-btn').textContent = 'Update Transaction';
                
                // Open modal
                document.getElementById('modal-backdrop').style.display = 'block';
                document.getElementById('txnModal').style.display = 'flex';
                
            } catch (error) {
                showAlertDialog('Error loading transaction: ' + error.message, 'Error');
            }
        }

        // Delete Transaction
        async function deleteTransaction(id) {
            showConfirmDialog('Are you sure you want to delete this transaction? This action cannot be undone.', 'Delete Transaction', (result) => {
                if (!result) return;
                deleteTransactionConfirmed(id);
            });
            return;
        }

        async function deleteTransactionConfirmed(id) {
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/transactions/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + getToken() }
                });
                
                if (res.status === 403) {
                    showConfirmDialog('Session expired. Log in again?', 'Session Expired', (result) => {
                        if (result) {
                            localStorage.removeItem('jwtToken');
                            window.location.href = 'index.html';
                        }
                    });
                    return;
                }
                
                if (res.ok) {
                    // Set flag to prevent refreshData from interfering
                    isDeleting = true;
                    
                    // Remove from local cache immediately
                    allTransactions = allTransactions.filter(t => t.id !== id);
                    window.allTransactions = allTransactions;
                    
                    // Remove row directly from DOM immediately for instant feedback
                    const row = document.querySelector(`tr[data-transaction-id="${id}"]`);
                    if (row) {
                        row.remove();
                    }
                    
                    // Update UI immediately - this will refresh the table with remaining items
                    applyFilters(false);
                    
                    // Show success message
                    showAlertDialog('Transaction deleted successfully!', 'Success');
                    
                    // Clear flag and refresh from server in background after delay
                    setTimeout(() => {
                        isDeleting = false;
                        refreshData().catch(err => console.error('Background refresh error:', err));
                    }, 2000);
                } else if (res.status === 404) {
                    // Transaction already deleted - remove from UI cache
                    allTransactions = allTransactions.filter(t => t.id !== id);
                    window.allTransactions = allTransactions;
                    applyFilters(false);
                    showAlertDialog('Transaction was already deleted.', 'Info');
                } else {
                    const errorText = await res.text();
                    showAlertDialog('Failed to delete transaction: ' + errorText, 'Error');
                }
            } catch (error) {
                // If network error, check if transaction exists in cache and remove it anyway
                const transactionExists = allTransactions.some(t => t.id === id);
                if (transactionExists) {
                    allTransactions = allTransactions.filter(t => t.id !== id);
                    window.allTransactions = allTransactions;
                    applyFilters(false);
                    showAlertDialog('Network error. Transaction removed from view. Please refresh to sync with server.', 'Warning');
                } else {
                    showAlertDialog('Error: ' + error.message, 'Error');
                }
            }
        }

        // Bulk Selection Functions
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all-checkbox');
            const checkboxes = document.querySelectorAll('.transaction-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
            const count = checkboxes.length;
            document.getElementById('selected-count').textContent = `${count} selected`;
            
            const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
            if (count > 0) {
                bulkDeleteBtn.style.display = 'flex';
            } else {
                bulkDeleteBtn.style.display = 'none';
            }
            
            // Update select all checkbox state
            const allCheckboxes = document.querySelectorAll('.transaction-checkbox');
            const selectAll = document.getElementById('select-all-checkbox');
            if (allCheckboxes.length === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            } else if (count === allCheckboxes.length) {
                selectAll.checked = true;
                selectAll.indeterminate = false;
            } else {
                selectAll.checked = false;
                selectAll.indeterminate = count > 0;
            }
        }

        // Bulk Delete
        async function bulkDeleteTransactions() {
            const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (ids.length === 0) {
                showAlertDialog('Please select at least one transaction to delete.', 'No Selection');
                return;
            }
            
            showConfirmDialog(`Are you sure you want to delete ${ids.length} transaction(s)? This action cannot be undone.`, 'Delete Transactions', (result) => {
                if (!result) return;
                bulkDeleteTransactionsConfirmed(ids);
            });
            return;
        }

        async function bulkDeleteTransactionsConfirmed(ids) {
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/transactions/bulk`, {
                    method: 'DELETE',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getToken() 
                    },
                    body: JSON.stringify({ ids: ids })
                });
                
                if (res.status === 403) {
                    showConfirmDialog('Session expired. Log in again?', 'Session Expired', (result) => {
                        if (result) {
                            localStorage.removeItem('jwtToken');
                            window.location.href = 'index.html';
                        }
                    });
                    return;
                }
                
                if (res.ok) {
                    // Set flag to prevent refreshData from interfering
                    isDeleting = true;
                    
                    // Remove from local cache immediately
                    allTransactions = allTransactions.filter(t => !ids.includes(t.id));
                    window.allTransactions = allTransactions;
                    
                    // Remove rows directly from DOM immediately for instant feedback
                    ids.forEach(id => {
                        const row = document.querySelector(`tr[data-transaction-id="${id}"]`);
                        if (row) {
                            row.remove();
                        }
                    });
                    
                    // Clear selection state immediately
                    document.getElementById('select-all-checkbox').checked = false;
                    document.getElementById('select-all-checkbox').indeterminate = false;
                    document.getElementById('selected-count').textContent = '0 selected';
                    document.getElementById('bulk-delete-btn').style.display = 'none';
                    
                    // Update UI immediately to refresh table with remaining items (don't reset page)
                    applyFilters(false);
                    
                    // Show success message
                    const message = ids.length === 1 
                        ? 'Transaction deleted successfully!' 
                        : `${ids.length} transactions deleted successfully!`;
                    showAlertDialog(message, 'Success');
                    
                    // Clear flag and refresh from server in background after delay
                    setTimeout(() => {
                        isDeleting = false;
                        refreshData().catch(err => console.error('Background refresh error:', err));
                    }, 2000);
                } else {
                    const errorText = await res.text();
                    showAlertDialog('Failed to delete transactions: ' + errorText, 'Error');
                }
            } catch (error) {
                // If network error, remove from cache anyway
                allTransactions = allTransactions.filter(t => !ids.includes(t.id));
                window.allTransactions = allTransactions;
                applyFilters(false);
                
                // Ensure selection is cleared
                document.getElementById('select-all-checkbox').checked = false;
                document.getElementById('select-all-checkbox').indeterminate = false;
                document.getElementById('selected-count').textContent = '0 selected';
                document.getElementById('bulk-delete-btn').style.display = 'none';
                
                showAlertDialog('Network error. Transactions removed from view. Please refresh to sync with server.', 'Warning');
            }
        }

        function confirmLogout() {
            // Update sidebar indicator to highlight logout button
            const logoutButton = document.querySelector('.sidebar-logout');
            const indicator = document.getElementById('sidebar-indicator');
            if (logoutButton && indicator) {
                const sidebarContainer = document.querySelector('.sidebar');
                if (sidebarContainer) {
                    const containerRect = sidebarContainer.getBoundingClientRect();
                    const itemRect = logoutButton.getBoundingClientRect();
                    const itemTop = itemRect.top - containerRect.top;
                    indicator.style.top = itemTop + 'px';
                }
            }
            
            showConfirmDialog('Are you sure you want to logout?', 'Confirm Logout', (result) => {
                if (result) {
                    logout();
                }
            });
        }

        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = 'index.html';
        }

        // Lightbox for viewing attachments
        let currentFiles = [];
        let currentFileIndex = 0;

        function viewAttachments(urls) {
            const fileUrls = urls.split(',').map(url => API_BASE_URL + url.trim());
            
            // Check if any files are PDFs
            const pdfFiles = fileUrls.filter(url => getFileExtension(url) === 'pdf');
            const nonPdfFiles = fileUrls.filter(url => getFileExtension(url) !== 'pdf');
            
            // If there are PDFs, open them in new tabs
            pdfFiles.forEach(url => {
                window.open(url, '_blank');
            });
            
            // If there are non-PDF files, show them in lightbox
            if (nonPdfFiles.length > 0) {
                currentFiles = nonPdfFiles;
                currentFileIndex = 0;
                showFile();
                document.getElementById('lightbox').classList.add('active');
            }
        }

        function getFileExtension(url) {
            const parts = url.split('.');
            return parts.length > 1 ? parts.pop().toLowerCase() : '';
        }

        function showFile() {
            const container = document.getElementById('lightbox-content');
            const counter = document.getElementById('lightbox-counter');
            const url = currentFiles[currentFileIndex];
            const ext = getFileExtension(url);
            
            counter.textContent = `${currentFileIndex + 1} / ${currentFiles.length}`;
            
            // Check file type and render accordingly
            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(ext)) {
                // Image file
                container.innerHTML = `<img src="${url}" alt="Attachment" onerror="showFileError()">`;
            } else if (ext === 'pdf') {
                // PDF file - show in iframe or download link
                container.innerHTML = `
                    <iframe src="${url}" title="PDF Document"></iframe>
                    <a href="${url}" target="_blank" class="lightbox-download" onclick="event.stopPropagation()">
                        <i class="fa-solid fa-download"></i> Open PDF in New Tab
                    </a>
                `;
            } else if (['doc', 'docx'].includes(ext)) {
                // Word document - can't preview, show download
                container.innerHTML = `
                    <div class="lightbox-error">
                        <i class="fa-solid fa-file-word"></i>
                        <p>Word Document</p>
                        <a href="${url}" download class="lightbox-download" onclick="event.stopPropagation()">
                            <i class="fa-solid fa-download"></i> Download File
                        </a>
                    </div>
                `;
            } else {
                // Unknown file type or error
                container.innerHTML = `
                    <div class="lightbox-error">
                        <i class="fa-solid fa-file"></i>
                        <p>Preview not available</p>
                        <a href="${url}" download class="lightbox-download" onclick="event.stopPropagation()">
                            <i class="fa-solid fa-download"></i> Download File
                        </a>
                    </div>
                `;
            }
        }

        function showFileError() {
            const container = document.getElementById('lightbox-content');
            const url = currentFiles[currentFileIndex];
            container.innerHTML = `
                <div class="lightbox-error">
                    <i class="fa-solid fa-circle-exclamation"></i>
                    <p>Failed to load attachment</p>
                    <p style="font-size: 12px; color: #52525b; margin-top: 8px;">File may have been deleted or upload failed</p>
                    <a href="${url}" target="_blank" class="lightbox-download" onclick="event.stopPropagation()">
                        <i class="fa-solid fa-external-link"></i> Try Opening Directly
                    </a>
                </div>
            `;
        }

        function closeLightbox(event) {
            if (event && event.target !== document.getElementById('lightbox')) return;
            document.getElementById('lightbox').classList.remove('active');
            document.getElementById('lightbox-content').innerHTML = '';
        }

        function prevFile(event) {
            event.stopPropagation();
            currentFileIndex = (currentFileIndex - 1 + currentFiles.length) % currentFiles.length;
            showFile();
        }

        function nextFile(event) {
            event.stopPropagation();
            currentFileIndex = (currentFileIndex + 1) % currentFiles.length;
            showFile();
        }

        // Close lightbox on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowLeft') prevFile({ stopPropagation: () => {} });
            if (e.key === 'ArrowRight') nextFile({ stopPropagation: () => {} });
        });

        // Budget Functions
        async function loadBudgets() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/budgets`, {
                    headers: { 'Authorization': 'Bearer ' + getToken() }
                });
                
                if (res.status === 403) {
                    showConfirmDialog('Session expired. Log in again?', 'Session Expired', (result) => {
                        if (result) {
                            localStorage.removeItem('jwtToken');
                            window.location.href = 'index.html';
                        }
                    });
                    return;
                }
                
                if (!res.ok) return;
                
                const budgets = await res.json();
                renderBudgets(budgets);
            } catch (error) {
                console.error('Error loading budgets:', error);
            }
        }

        function renderBudgets(budgets) {
            const grid = document.getElementById('budget-grid');
            
            // Create "Create New Budget" card
            let html = `
                <div class="budget-card create-new" onclick="openBudgetModal()">
                    <i class="fa-solid fa-plus create-budget-icon"></i>
                    <p class="create-budget-text">Create New Budget</p>
                </div>
            `;
            
            // Calculate spent amounts from actual transactions
            const categorySpent = {};
            const categoryItemCount = {};
            
            if (window.allTransactions && window.allTransactions.length > 0) {
                window.allTransactions.forEach(t => {
                    if (t.type === 'EXPENSE' && t.category) {
                        if (!categorySpent[t.category]) {
                            categorySpent[t.category] = 0;
                            categoryItemCount[t.category] = 0;
                        }
                        categorySpent[t.category] += (t.amount || 0);
                        categoryItemCount[t.category] += 1;
                    }
                });
            }
            
            // Add budget cards
            budgets.forEach(budget => {
                const category = allCategories.find(c => c.name === budget.category);
                const icon = category ? category.icon : 'fa-circle-question';
                const color = category ? category.colour : '#52525b';
                
                // Use calculated values from transactions, fallback to backend values
                const spent = categorySpent[budget.category] !== undefined ? categorySpent[budget.category] : (budget.spent || 0);
                const itemCount = categoryItemCount[budget.category] !== undefined ? categoryItemCount[budget.category] : (budget.itemCount || 0);
                const amount = budget.amount || 0;
                const remaining = Math.max(0, amount - spent);
                // Ensure progress is exactly 0 when spent is 0 or no items
                const progress = (spent > 0 && amount > 0) ? Math.min((spent / amount) * 100, 100) : 0;
                
                html += `
                    <div class="budget-card" onclick="openBudgetDetailModal(${budget.id}, '${budget.category}', ${budget.amount || 0})" style="cursor: pointer;">
                        <div class="budget-card-header">
                            <div class="budget-icon" style="background: ${color}20; color: ${color};">
                                <i class="fa-solid ${icon}"></i>
                            </div>
                            <div class="budget-info">
                                <div class="budget-category">${budget.category}</div>
                                <div class="budget-item-count">${itemCount} Item${itemCount !== 1 ? 's' : ''}</div>
                            </div>
                            <div class="budget-amount">${formatCurrency(budget.amount || 0)}</div>
                        </div>
                        <div class="budget-stats">
                            <span class="budget-spent">${formatCurrency(spent)} Spent</span>
                            <span class="budget-remaining">${formatCurrency(remaining)} Remaining</span>
                        </div>
                        <div class="budget-progress-bar">
                            <div class="budget-progress-fill" style="width: ${progress}%; ${progress === 0 ? 'display: none;' : ''}"></div>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }

        function openBudgetModal() {
            // Populate category dropdown
            const select = document.getElementById('budget-category-select');
            select.innerHTML = '<option value="">Select a category</option>';
            
            // Filter out categories that already have budgets
            const existingBudgets = Array.from(document.querySelectorAll('.budget-card:not(.create-new)'))
                .map(card => card.querySelector('.budget-category')?.textContent)
                .filter(Boolean);
            
            // Sort categories alphabetically before adding to dropdown
            const availableCategories = allCategories
                .filter(c => !existingBudgets.includes(c.name))
                .sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }));
            
            availableCategories.forEach(c => {
                const option = document.createElement('option');
                option.value = c.name;
                option.textContent = c.name;
                select.appendChild(option);
            });
            
            document.getElementById('budget-amount-input').value = '';
            document.getElementById('modal-backdrop').style.display = 'block';
            document.getElementById('budgetModal').style.display = 'flex';
        }

        function closeBudgetModal() {
            document.getElementById('modal-backdrop').style.display = 'none';
            document.getElementById('budgetModal').style.display = 'none';
        }

        async function createBudget() {
            const category = document.getElementById('budget-category-select').value;
            const amount = parseFloat(document.getElementById('budget-amount-input').value);
            
            if (!category) { showAlertDialog('Please select a category', 'Validation Error'); return; }
            if (!amount || amount <= 0) { showAlertDialog('Please enter a valid amount', 'Validation Error'); return; }
            
            const btn = document.querySelector('#budgetModal .save-btn');
            btn.disabled = true;
            btn.textContent = 'Creating...';
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/budgets`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': 'Bearer ' + getToken() 
                    },
                    body: JSON.stringify({ category, amount })
                });
                
                if (res.status === 403) {
                    showConfirmDialog('Session expired. Log in again?', 'Session Expired', (result) => {
                        if (result) {
                            localStorage.removeItem('jwtToken');
                            window.location.href = 'index.html';
                        }
                    });
                    return;
                }
                
                if (res.ok) {
                    closeBudgetModal();
                    loadBudgets();
                } else {
                    showAlertDialog('Failed to create budget.', 'Error');
                }
            } catch (error) {
                showAlertDialog('Error: ' + error.message, 'Error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Budget';
            }
        }

        // Budget Detail Modal Functions
        let currentBudgetId = null;
        let currentBudgetCategory = null;

        async function openBudgetDetailModal(budgetId, category, amount) {
            currentBudgetId = budgetId;
            currentBudgetCategory = category;
            
            // Set modal title and initial values
            document.getElementById('budget-detail-category').textContent = category;
            document.getElementById('budget-edit-amount').value = amount;
            
            // Show modal
            document.getElementById('modal-backdrop').style.display = 'block';
            document.getElementById('budgetDetailModal').style.display = 'flex';
            
            // Load budget details and transactions
            await loadBudgetDetails(budgetId);
            await loadBudgetTransactions(category);
        }

        function closeBudgetDetailModal() {
            document.getElementById('modal-backdrop').style.display = 'none';
            document.getElementById('budgetDetailModal').style.display = 'none';
            currentBudgetId = null;
            currentBudgetCategory = null;
        }

        async function loadBudgetDetails(budgetId) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/budgets`, {
                    headers: { 'Authorization': 'Bearer ' + getToken() }
                });
                
                if (res.status === 403) {
                    showConfirmDialog('Session expired. Log in again?', 'Session Expired', (result) => {
                        if (result) {
                            localStorage.removeItem('jwtToken');
                            window.location.href = 'index.html';
                        }
                    });
                    return;
                }
                
                if (!res.ok) return;
                
                const budgets = await res.json();
                const budget = budgets.find(b => b.id === budgetId);
                
                if (budget) {
                    const spent = budget.spent || 0;
                    const total = budget.amount || 0;
                    const remaining = budget.remaining || 0;
                    const itemCount = budget.itemCount || 0;
                    const progress = total > 0 ? Math.min((spent / total) * 100, 100) : 0;
                    
                    document.getElementById('budget-detail-amount').textContent = formatCurrency(total);
                    document.getElementById('budget-detail-spent').textContent = formatCurrency(spent);
                    document.getElementById('budget-detail-remaining').textContent = formatCurrency(remaining);
                    document.getElementById('budget-detail-stats').textContent = `${itemCount} Item${itemCount !== 1 ? 's' : ''}`;
                    document.getElementById('budget-detail-progress').style.width = `${progress}%`;
                }
            } catch (error) {
                console.error('Error loading budget details:', error);
            }
        }

        async function loadBudgetTransactions(category) {
            const listContainer = document.getElementById('budget-transactions-list');
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/transactions`, {
                    headers: { 'Authorization': 'Bearer ' + getToken() }
                });
                
                if (res.status === 403) {
                    listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #a1a1aa; font-size: 13px;">Session expired</div>';
                    return;
                }
                
                if (!res.ok) {
                    listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #ff5757; font-size: 13px;">Failed to load transactions</div>';
                    return;
                }
                
                const transactions = await res.json();
                const categoryTransactions = transactions.filter(t => 
                    t.category === category && t.type === 'EXPENSE'
                ).sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Calculate spent amount and item count from actual transactions
                const spent = categoryTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
                const itemCount = categoryTransactions.length;
                
                // Get budget amount to calculate remaining and progress
                const budgetAmountElement = document.getElementById('budget-detail-amount');
                const budgetAmountText = budgetAmountElement ? budgetAmountElement.textContent : 'RM 0.00';
                const budgetAmount = parseFloat(budgetAmountText.replace(/[^\d.-]/g, '')) || 0;
                const remaining = Math.max(0, budgetAmount - spent);
                const progress = budgetAmount > 0 ? Math.min((spent / budgetAmount) * 100, 100) : 0;
                
                // Update budget details with calculated values
                document.getElementById('budget-detail-spent').textContent = formatCurrency(spent);
                document.getElementById('budget-detail-remaining').textContent = formatCurrency(remaining);
                document.getElementById('budget-detail-stats').textContent = `${itemCount} Item${itemCount !== 1 ? 's' : ''}`;
                document.getElementById('budget-detail-progress').style.width = `${progress}%`;
                
                if (categoryTransactions.length === 0) {
                    listContainer.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #a1a1aa;">
                            <i class="fa-solid fa-receipt" style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></i>
                            <div style="font-size: 13px;">No transactions found in this category</div>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div style="max-height: 400px; overflow-y: auto;">';
                categoryTransactions.forEach(t => {
                    const hasAttachment = t.receiptImage && t.receiptImage.length > 0;
                    html += `
                        <div style="display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid #27272a; transition: background 0.2s;" onmouseover="this.style.background='#1a1a1a'" onmouseout="this.style.background='transparent'">
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 600; color: #fff; margin-bottom: 4px;">${t.description || 'No description'}</div>
                                <div style="font-size: 11px; color: #a1a1aa;">${formatDate(t.date)} ${hasAttachment ? '<i class="fa-solid fa-paperclip" style="margin-left: 8px;"></i>' : ''}</div>
                            </div>
                            <div style="font-size: 14px; font-weight: 600; color: #ff5757; margin-right: 12px;">${formatCurrency(t.amount)}</div>
                            <div style="display: flex; gap: 6px;">
                                <button onclick="editTransaction(${t.id}); event.stopPropagation();" style="padding: 6px 10px; background: #3f3f46; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; transition: all 0.2s;" onmouseover="this.style.background='#52525b'" onmouseout="this.style.background='#3f3f46'">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button onclick="deleteTransaction(${t.id}); event.stopPropagation();" style="padding: 6px 10px; background: #dc2626; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; transition: all 0.2s;" onmouseover="this.style.background='#ef4444'" onmouseout="this.style.background='#dc2626'">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                listContainer.innerHTML = html;
            } catch (error) {
                console.error('Error loading budget transactions:', error);
                listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #ff5757; font-size: 13px;">Error loading transactions</div>';
            }
        }

        async function updateBudgetAmount() {
            if (!currentBudgetId) return;
            
            const newAmount = parseFloat(document.getElementById('budget-edit-amount').value);
            
            if (!newAmount || newAmount <= 0) {
                showAlertDialog('Please enter a valid amount', 'Validation Error');
                return;
            }
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin" style="margin-right: 6px;"></i>Updating...';
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/budgets/${currentBudgetId}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': 'Bearer ' + getToken() 
                    },
                    body: JSON.stringify({ amount: newAmount })
                });
                
                if (res.status === 403) {
                    showConfirmDialog('Session expired. Log in again?', 'Session Expired', (result) => {
                        if (result) {
                            localStorage.removeItem('jwtToken');
                            window.location.href = 'index.html';
                        }
                    });
                    return;
                }
                
                if (res.ok) {
                    showAlertDialog('Budget updated successfully!', 'Success');
                    await loadBudgetDetails(currentBudgetId);
                    loadBudgets(); // Refresh budget list
                } else {
                    showAlertDialog('Failed to update budget.', 'Error');
                }
            } catch (error) {
                showAlertDialog('Error: ' + error.message, 'Error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function confirmDeleteBudget() {
            if (!currentBudgetId) return;
            
            showConfirmDialog(
                `Are you sure you want to delete the budget for "${currentBudgetCategory}"? This action cannot be undone.`,
                'Delete Budget',
                async (confirmed) => {
                    if (confirmed) {
                        await deleteBudget();
                    }
                }
            );
        }

        async function deleteBudget() {
            if (!currentBudgetId) return;
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/budgets/${currentBudgetId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + getToken() }
                });
                
                if (res.status === 403) {
                    showConfirmDialog('Session expired. Log in again?', 'Session Expired', (result) => {
                        if (result) {
                            localStorage.removeItem('jwtToken');
                            window.location.href = 'index.html';
                        }
                    });
                    return;
                }
                
                if (res.ok) {
                    showAlertDialog('Budget deleted successfully!', 'Success');
                    closeBudgetDetailModal();
                    loadBudgets(); // Refresh budget list
                } else {
                    showAlertDialog('Failed to delete budget.', 'Error');
                }
            } catch (error) {
                showAlertDialog('Error: ' + error.message, 'Error');
            }
        }


        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            
            // Use default date format: DD/MM/YYYY
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            
            return `${day}/${month}/${year}`;
        }

        // Export Functions
        function getFilteredTransactions() {
            // Get currently filtered/displayed transactions
            if (!allTransactions || allTransactions.length === 0) return [];
            
            // Apply the same filters that are currently active
            let filtered = applyFiltersToData(allTransactions);
            return filtered;
        }

        // Export History Management - Now using database
        async function loadExportHistory() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/exports`, {
                    headers: {
                        'Authorization': 'Bearer ' + getToken()
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load export history');
                }

                const exports = await response.json();
                const exportsList = document.getElementById('exports-list');
                
                if (exports.length === 0) {
                    exportsList.innerHTML = '<div style="text-align: center; color: #a1a1aa; padding: 40px;">No exports yet. Use the Export button to create your first export.</div>';
                    return;
                }
                
                let html = '';
                exports.forEach(exp => {
                    const exportDate = new Date(exp.exportedAt);
                    // Format date part using user's selected format
                    const datePart = formatDate(exportDate.toISOString().split('T')[0]);
                    // Add time part
                    const hours = String(exportDate.getHours()).padStart(2, '0');
                    const minutes = String(exportDate.getMinutes()).padStart(2, '0');
                    const dateStr = `${datePart} ${hours}:${minutes}`;
                    
                    let filters = {};
                    try {
                        filters = JSON.parse(exp.filters || '{}');
                    } catch (e) {
                        filters = {};
                    }
                    
                    html += `
                        <div style="background: #18181b; padding: 16px; border-radius: 8px; border: 1px solid #27272a; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                <input type="checkbox" class="export-checkbox" value="${exp.id}" onchange="updateSelectedExportsCount()" style="margin: 0;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <i class="fa-solid fa-file-${exp.format === 'PDF' ? 'pdf' : 'excel'}" style="color: ${exp.format === 'PDF' ? '#ff5757' : '#48c6ef'}; font-size: 20px;"></i>
                                        <div>
                                            <div style="color: #fff; font-weight: 600; font-size: 14px;">${exp.filename}</div>
                                            <div style="color: #a1a1aa; font-size: 12px; margin-top: 4px;">
                                                ${exp.transactionCount} transactions • ${filters.typeCategory || 'All Types & Categories'} • ${filters.dateRange || 'All Time'}
                                            </div>
                                        </div>
                                    </div>
                                    <div style="color: #52525b; font-size: 11px;">Exported on ${dateStr}</div>
                                </div>
                            </div>
                            <button onclick="viewExportFromServer(${exp.id})" style="background: #3f3f46; color: #fff; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.background='#52525b'" onmouseout="this.style.background='#3f3f46'">
                                <i class="fa-solid fa-eye"></i> View
                            </button>
                        </div>
                    `;
                });
                
                exportsList.innerHTML = html;
                
                // Reset selection state - ensure it's cleared
                const selectAllCheckbox = document.getElementById('select-all-exports-checkbox');
                const selectedCount = document.getElementById('selected-exports-count');
                const bulkDeleteBtn = document.getElementById('bulk-delete-exports-btn');
                
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                }
                if (selectedCount) {
                    selectedCount.textContent = '0 selected';
                }
                if (bulkDeleteBtn) {
                    bulkDeleteBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading export history:', error);
                const exportsList = document.getElementById('exports-list');
                exportsList.innerHTML = '<div style="text-align: center; color: #ff5757; padding: 40px;">Failed to load export history. Please refresh the page.</div>';
                
                // Reset selection state even on error
                document.getElementById('select-all-exports-checkbox').checked = false;
                document.getElementById('select-all-exports-checkbox').indeterminate = false;
                updateSelectedExportsCount();
            }
        }

        async function viewExportFromServer(exportId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/exports/${exportId}/download`, {
                    headers: {
                        'Authorization': 'Bearer ' + getToken()
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to view export');
                }

                const blob = await response.blob();
                
                // Verify blob is not empty
                if (blob.size === 0) {
                    throw new Error('Export file is empty');
                }
                
                const url = URL.createObjectURL(blob);
                
                // Open in new tab for viewing
                const newWindow = window.open(url, '_blank');
                
                // Clean up the URL after a longer delay to ensure the file loads
                // Don't revoke if window failed to open
                if (newWindow) {
                    setTimeout(() => URL.revokeObjectURL(url), 5000);
                } else {
                    URL.revokeObjectURL(url);
                    showAlertDialog('Please allow pop-ups to view the export file.', 'Pop-up Blocked');
                }
            } catch (error) {
                console.error('Error viewing export:', error);
                showAlertDialog('Failed to view export: ' + error.message, 'Error');
            }
        }

        function toggleSelectAllExports() {
            const selectAll = document.getElementById('select-all-exports-checkbox');
            const checkboxes = document.querySelectorAll('.export-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateSelectedExportsCount();
        }

        function updateSelectedExportsCount() {
            const checkboxes = document.querySelectorAll('.export-checkbox:checked');
            const count = checkboxes.length;
            document.getElementById('selected-exports-count').textContent = `${count} selected`;
            
            const bulkDeleteBtn = document.getElementById('bulk-delete-exports-btn');
            if (count > 0) {
                bulkDeleteBtn.style.display = 'block';
            } else {
                bulkDeleteBtn.style.display = 'none';
            }
            
            // Update select all checkbox state
            const allCheckboxes = document.querySelectorAll('.export-checkbox');
            const selectAll = document.getElementById('select-all-exports-checkbox');
            if (allCheckboxes.length === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            } else if (count === allCheckboxes.length) {
                selectAll.checked = true;
                selectAll.indeterminate = false;
            } else {
                selectAll.checked = false;
                selectAll.indeterminate = count > 0;
            }
        }

        async function bulkDeleteExports() {
            const checkboxes = document.querySelectorAll('.export-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (ids.length === 0) {
                showAlertDialog('Please select at least one export to delete.', 'No Selection');
                return;
            }
            
            showConfirmDialog(`Are you sure you want to delete ${ids.length} export(s)? This action cannot be undone.`, 'Delete Exports', async (result) => {
                if (!result) return;
                
                try {
                    // Delete all selected exports
                    const deletePromises = ids.map(id => 
                        fetch(`${API_BASE_URL}/api/exports/${id}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': 'Bearer ' + getToken()
                            }
                        })
                    );
                    
                    const results = await Promise.all(deletePromises);
                    const failed = results.filter(r => !r.ok);
                    
                    if (failed.length === 0) {
                        // Reset checkboxes BEFORE loading history
                        document.getElementById('select-all-exports-checkbox').checked = false;
                        document.getElementById('select-all-exports-checkbox').indeterminate = false;
                        
                        // Reload export history (this will also reset selection state)
                        await loadExportHistory();
                        
                        // Ensure selection is cleared after reload
                        updateSelectedExportsCount();
                        
                        showAlertDialog(`Successfully deleted ${ids.length} export(s).`, 'Success');
                    } else {
                        showAlertDialog(`Failed to delete ${failed.length} export(s). Please try again.`, 'Error');
                    }
                } catch (error) {
                    console.error('Error deleting exports:', error);
                    showAlertDialog('Error deleting exports: ' + error.message, 'Error');
                }
            });
        }

        function getFilteredTransactionsForExport() {
            if (!allTransactions || allTransactions.length === 0) return [];
            
            let filtered = [...allTransactions];
            
            // Apply type/category filter
            const typeCategoryFilter = document.getElementById('export-filter-type-category').value;
            if (typeCategoryFilter) {
                if (typeCategoryFilter === 'EXPENSE' || typeCategoryFilter === 'INCOME') {
                    filtered = filtered.filter(t => t.type === typeCategoryFilter);
                } else {
                    filtered = filtered.filter(t => t.category === typeCategoryFilter);
                }
            }
            
            // Apply date range filter
            const dateRange = document.getElementById('export-filter-date-range').value;
            if (dateRange !== 'all') {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (dateRange === 'week') {
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    filtered = filtered.filter(t => new Date(t.date) >= weekStart);
                } else if (dateRange === 'month') {
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    filtered = filtered.filter(t => new Date(t.date) >= monthStart);
                } else if (dateRange === 'custom') {
                    const dateFrom = document.getElementById('export-date-from').value;
                    const dateTo = document.getElementById('export-date-to').value;
                    if (dateFrom) {
                        filtered = filtered.filter(t => new Date(t.date) >= new Date(dateFrom));
                    }
                    if (dateTo) {
                        const toDate = new Date(dateTo);
                        toDate.setHours(23, 59, 59);
                        filtered = filtered.filter(t => new Date(t.date) <= toDate);
                    }
                }
            }
            
            return filtered;
        }

        function exportToExcel(transactions, exportDate) {
            if (!transactions || transactions.length === 0) {
                showAlertDialog('No transactions to export.', 'Export');
                return null;
            }

            // CSV format with proper comma separation and quoting
            const escapeCSV = (value) => {
                if (value === null || value === undefined) return '';
                const stringValue = String(value);
                // If value contains comma, quote, or newline, wrap in quotes and escape quotes
                if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                    return '"' + stringValue.replace(/"/g, '""') + '"';
                }
                return stringValue;
            };

            const headers = ['Date', 'Description', 'Type', 'Category', 'Amount', 'Recurring', 'Frequency'];
            
            const csvRows = [
                headers.map(escapeCSV).join(',')
            ];

            transactions.forEach(t => {
                const row = [
                    escapeCSV(t.date || ''),
                    escapeCSV(t.description || ''),
                    escapeCSV(t.type || ''),
                    escapeCSV(t.type === 'INCOME' ? (t.category || '-') : (t.category || '')),
                    escapeCSV(t.amount || 0),
                    escapeCSV(t.isRecurring ? 'Yes' : 'No'),
                    escapeCSV(t.recurringFrequency || '')
                ];
                csvRows.push(row.join(','));
            });

            // Add UTF-8 BOM for Excel compatibility
            const BOM = '\uFEFF';
            const csvContent = BOM + csvRows.join('\r\n'); // Use \r\n for Windows Excel compatibility
            
            // Create blob with CSV MIME type
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `transactions_${exportDate}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            return blob;
        }

        async function generatePDFReport(transactions, exportDate) {
            if (!transactions || transactions.length === 0) {
                showAlertDialog('No transactions to export.', 'Export');
                return null;
            }

            try {
                const { jsPDF } = window.jspdf;
                
                // Calculate summary statistics
                const totalIncome = transactions
                    .filter(t => t.type === 'INCOME')
                    .reduce((sum, t) => sum + (t.amount || 0), 0);
                
                const totalExpense = transactions
                    .filter(t => t.type === 'EXPENSE')
                    .reduce((sum, t) => sum + (t.amount || 0), 0);
                
                // Group by category
                const categoryTotals = {};
                transactions.forEach(t => {
                    if (t.type === 'EXPENSE') {
                        const cat = t.category || 'Uncategorized';
                        categoryTotals[cat] = (categoryTotals[cat] || 0) + (t.amount || 0);
                    }
                });

                // Create PDF document
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                // Set margins
                const margin = 10;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let yPos = margin;

                // Helper function to add new page if needed
                const checkPageBreak = (requiredHeight) => {
                    if (yPos + requiredHeight > pageHeight - margin) {
                        doc.addPage();
                        yPos = margin;
                        return true;
                    }
                    return false;
                };

                // Title
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('Transaction Report', margin, yPos);
                yPos += 10;

                // Report date
                const today = new Date();
                const reportDate = formatDate(today.toISOString().split('T')[0]) + ' ' + today.toLocaleTimeString('en-US', { 
                    hour: '2-digit',
                    minute: '2-digit'
                });
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text('Generated on ' + reportDate, margin, yPos);
                yPos += 8;

                // Summary section
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Summary', margin, yPos);
                yPos += 7;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Total Transactions: ' + transactions.length, margin, yPos);
                yPos += 6;

                doc.setFont(undefined, 'bold');
                doc.setTextColor(22, 163, 74); // Green for income
                doc.text('Total Income: ' + formatCurrency(totalIncome), margin, yPos);
                yPos += 6;

                doc.setTextColor(255, 87, 87); // Red for expense
                doc.text('Total Expense: ' + formatCurrency(totalExpense), margin, yPos);
                yPos += 10;

                // Sort transactions by date (oldest first)
                const sortedTransactions = [...transactions].sort((a, b) => 
                    new Date(a.date) - new Date(b.date)
                );

                // Prepare transaction data for table
                const tableData = sortedTransactions.map(t => [
                    formatDate(t.date),
                    (t.description || '').substring(0, 40), // Limit description length
                    t.type || '',
                    t.type === 'INCOME' ? (t.category || '-') : (t.category || 'Uncategorized'),
                    (t.type === 'INCOME' ? '+' : '-') + formatCurrency(t.amount || 0)
                ]);

                // Transactions table
                checkPageBreak(15);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Transactions', margin, yPos);
                yPos += 7;

                // Use autoTable for transactions
                doc.autoTable({
                    startY: yPos,
                    head: [['Date', 'Description', 'Type', 'Category', 'Amount']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [255, 255, 255],
                        textColor: [0, 0, 0],
                        fontStyle: 'bold',
                        lineColor: [0, 0, 0],
                        lineWidth: 0.5
                    },
                    bodyStyles: {
                        fillColor: [255, 255, 255],
                        textColor: [0, 0, 0],
                        lineColor: [0, 0, 0],
                        lineWidth: 0.5
                    },
                    alternateRowStyles: {
                        fillColor: [255, 255, 255]
                    },
                    styles: {
                        fontSize: 9,
                        cellPadding: 3,
                        font: 'helvetica'
                    },
                    columnStyles: {
                        0: { cellWidth: 30 }, // Date
                        1: { cellWidth: 60 }, // Description
                        2: { cellWidth: 25 }, // Type
                        3: { cellWidth: 35 }, // Category
                        4: { cellWidth: 30, halign: 'right' } // Amount
                    },
                    didParseCell: function(data) {
                        // Color amount column based on type
                        if (data.column.index === 4) {
                            const rowIndex = data.row.index;
                            if (rowIndex < tableData.length) {
                                const transaction = sortedTransactions[rowIndex];
                                if (transaction.type === 'INCOME') {
                                    data.cell.styles.textColor = [22, 163, 74]; // Green
                                } else {
                                    data.cell.styles.textColor = [255, 87, 87]; // Red
                                }
                            }
                        }
                    },
                    margin: { left: margin, right: margin },
                    pageBreak: 'auto',
                    rowPageBreak: 'avoid',
                    showHead: 'everyPage'
                });

                // Get final Y position after table
                yPos = doc.lastAutoTable.finalY + 10;

                // Expenses by Category section
                checkPageBreak(15);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Expenses by Category', margin, yPos);
                yPos += 7;

                // Sort categories by amount
                const sortedCategories = Object.entries(categoryTotals)
                    .sort((a, b) => b[1] - a[1]);

                // Category table
                const categoryData = sortedCategories.map(([category, amount]) => [
                    category,
                    formatCurrency(amount)
                ]);

                doc.autoTable({
                    startY: yPos,
                    head: [['Category', 'Amount']],
                    body: categoryData,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [255, 255, 255],
                        textColor: [0, 0, 0],
                        fontStyle: 'bold',
                        lineColor: [0, 0, 0],
                        lineWidth: 0.5
                    },
                    bodyStyles: {
                        fillColor: [255, 255, 255],
                        textColor: [255, 87, 87], // Red for expense amounts
                        lineColor: [0, 0, 0],
                        lineWidth: 0.5
                    },
                    styles: {
                        fontSize: 10,
                        cellPadding: 3,
                        font: 'helvetica'
                    },
                    columnStyles: {
                        0: { cellWidth: 120 }, // Category
                        1: { cellWidth: 60, halign: 'right' } // Amount
                    },
                    margin: { left: margin, right: margin },
                    pageBreak: 'auto',
                    rowPageBreak: 'avoid'
                });

                // Generate blob instead of saving directly
                const pdfBlob = doc.output('blob');
                
                // Also trigger download
                const url = URL.createObjectURL(pdfBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `transactions_${exportDate}.pdf`;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
                
                return pdfBlob;
            } catch (error) {
                console.error('Error generating PDF:', error);
                showAlertDialog('Failed to generate PDF: ' + error.message, 'Error');
                return null;
            }
        }

        // Export Modal Functions
        function openExportModal() {
            // Copy current filter values to export modal
            const typeCategoryFilter = document.getElementById('filter-type-category').value;
            const dateRangeFilter = document.getElementById('filter-date-range').value;
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            
            document.getElementById('export-filter-type-category').value = typeCategoryFilter || '';
            document.getElementById('export-filter-date-range').value = dateRangeFilter || 'all';
            
            if (dateFrom) document.getElementById('export-date-from').value = dateFrom;
            if (dateTo) document.getElementById('export-date-to').value = dateTo;
            
            // Populate category filter options
            populateExportCategoryFilter();
            
            // Show/hide custom date range
            handleExportDateRangeChange();
            
            document.getElementById('modal-backdrop').style.display = 'block';
            document.getElementById('exportModal').style.display = 'flex';
        }

        function closeExportModal() {
            document.getElementById('modal-backdrop').style.display = 'none';
            document.getElementById('exportModal').style.display = 'none';
        }

        function handleExportDateRangeChange() {
            const dateRange = document.getElementById('export-filter-date-range').value;
            const customDateRange = document.getElementById('export-custom-date-range');
            
            if (dateRange === 'custom') {
                customDateRange.style.display = 'flex';
            } else {
                customDateRange.style.display = 'none';
            }
        }

        function populateExportCategoryFilter() {
            const select = document.getElementById('export-filter-type-category');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">All Types & Categories</option>';
            select.innerHTML += '<option value="EXPENSE">Expense</option>';
            select.innerHTML += '<option value="INCOME">Income</option>';
            
            if (allCategories && allCategories.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'By Category';
                // Sort categories alphabetically
                const sortedCategories = [...allCategories].sort((a, b) => 
                    a.name.localeCompare(b.name, undefined, { sensitivity: 'base' })
                );
                sortedCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.textContent = cat.name;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            }
            
            if (currentValue) {
                select.value = currentValue;
            }
        }

        async function uploadExportToServer(blob, filename, format, transactionCount, filtersJson) {
            try {
                const formData = new FormData();
                formData.append('file', blob, filename);
                formData.append('filename', filename);
                formData.append('format', format.toUpperCase());
                formData.append('transactionCount', transactionCount);
                formData.append('filters', filtersJson);

                const response = await fetch(`${API_BASE_URL}/api/exports/save`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + getToken()
                    },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    return data;
                } else {
                    const error = await response.text();
                    throw new Error(error);
                }
            } catch (error) {
                console.error('Error uploading export:', error);
                throw error;
            }
        }

        async function performExport(format) {
            const transactions = getFilteredTransactionsForExport();
            
            if (transactions.length === 0) {
                showAlertDialog('No transactions to export with the selected filters.', 'Export');
                return;
            }
            
            const exportDate = new Date().toISOString().split('T')[0];
            
            // Get filter info for history
            const typeCategory = document.getElementById('export-filter-type-category').value || 'All Types & Categories';
            const dateRange = document.getElementById('export-filter-date-range').value;
            let dateRangeText = 'All Time';
            if (dateRange === 'week') dateRangeText = 'This Week';
            else if (dateRange === 'month') dateRangeText = 'This Month';
            else if (dateRange === 'custom') {
                const from = document.getElementById('export-date-from').value;
                const to = document.getElementById('export-date-to').value;
                dateRangeText = from && to ? `${from} to ${to}` : 'Custom Range';
            }
            
            const filtersJson = JSON.stringify({
                typeCategory: typeCategory,
                dateRange: dateRangeText,
                typeCategoryValue: document.getElementById('export-filter-type-category').value || '',
                dateRangeValue: dateRange,
                dateFrom: dateRange === 'custom' ? document.getElementById('export-date-from').value : null,
                dateTo: dateRange === 'custom' ? document.getElementById('export-date-to').value : null
            });
            
            const filename = `transactions_${exportDate}.${format === 'excel' ? 'csv' : 'pdf'}`;
            
            try {
                if (format === 'excel') {
                    const blob = exportToExcel(transactions, exportDate);
                    if (blob) {
                        // Upload to server
                        await uploadExportToServer(blob, filename, format, transactions.length, filtersJson);
                        closeExportModal();
                        showAlertDialog(`Exported and saved ${transactions.length} transactions to Excel.`, 'Export Successful');
                    }
                } else if (format === 'pdf') {
                    const blob = await generatePDFReport(transactions, exportDate);
                    if (blob) {
                        // Upload to server
                        await uploadExportToServer(blob, filename, format, transactions.length, filtersJson);
                        closeExportModal();
                        showAlertDialog(`Exported and saved ${transactions.length} transactions to PDF.`, 'Export Successful');
                    }
                }
                
                // Reload export history if on exports view
                if (document.getElementById('exports').classList.contains('active')) {
                    await loadExportHistory();
                }
            } catch (error) {
                showAlertDialog('Failed to save export to database: ' + error.message, 'Error');
            }
        }



    </script>
</body>
</html>
